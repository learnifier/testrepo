[#ftl strip_text="true" /]

[#import "projectInfo.html" as pInfo /]

[#assign cpweb_head]
${cpweb_head}

[/#assign]

[#assign cpweb_foot ]
${cpweb_foot}
<script>
    "use strict";
    $('#menu-projects').addClass('active');

    var settings = {
        listUploadsUrl: "${helper.urlFor('project.upload.UploadJsModule', 'listUploads',[prj.projectId])}",
        removeUploadUrl: "${helper.urlFor('project.upload.UploadJsModule', 'removeUpload')}"
    };

    require(['knockout', 'messenger', 'es6-shim'], function(ko) {
        $.getJSON(settings.listUploadsUrl).done(function(data) {

            console.log("Alright we got ", data.result);

            if(data.status == "ok") {
                // Knockout can't handle hashes, so lets restructure the data from
                // hash to array of hash with name and value.
                // TODO: I sort in cid and userId, should be names or possibly a counter.
                var components = Object.keys(data.result).sort().map(function(cid){
                    var componentMap = data.result[cid];
                    return {
                        cid: cid, componentName: componentMap.componentName,
                        participants: Object.keys(componentMap.component).sort().map(function(userId){
                            var component = componentMap.component;
                            return {
                                participantName: component[userId].participantName,
                                uploads: component[userId].uploads
                            }
                        })
                    };
                });
                console.log("Rehashed: ", components);
            }


            function UploadModel() {
                var self = this;
                this.remove = function(){
                    var upload = this;
                    console.log("Removing upload: ", upload);
                    $.post(settings.removeUploadUrl, { participationId: upload.participationId, uploadId: upload.uploadId}).done(function(data){
                        if(data.status == "ok") {
                            var index = self.uploadComponents().indexOf(uploadId);
                            if(index != -1) {
                                self.uploadComponents.splice(index, 1);
                            }
                            CCBMessengerInfo("Upload deleted.");
                        } else {
                            CCBMessengerError("Could not delete upload.");
                        }
                    }).fail(function(){
                        CCBMessengerError("Could not delete upload.");
                    });
                };
                this.uploadComponents = ko.observableArray(components);
            }
            var model = new UploadModel();
            ko.applyBindings(model, $("#downloads-container")[0])

        }).fail(function(jqXHR, textStatus, errorThrown){
            console.log("Could not fetch uploads: ", errorThrown);
            CCBMessengerError("Could not fetch uploaded files.");
        });
    });

</script>


[/#assign]

[#assign title = (prj.name!'') + " uploads ("+orgName+")" /]
[@dws.skin skin="CPAuth3" head=cpweb_head ctxMenu=cpweb_ctxMenu foot=cpweb_foot orgName=title]

[@pInfo.projectInfo selected="uploads"][/@pInfo.projectInfo]


<h1>[@dws.txt key="cpweb.project.uploads.title" /]</h1>

<form method="POST" action="{helper.urlFor('project.ProjectModificationModule','assignRoleEmail',[prj.projectId])}" class="form">
    <div class="form-group">
        [@modal.formParams /]
        <button type="submit" class="btn btn-primary">A random button</button>
    </div>
</form>

<div class="row">
    <div class="col-sm-12">
        <div id="downloads-container">
            <div data-bind="foreach: uploadComponents">
                <h1 data-bind="text: componentName"></h1>
                <div data-bind="foreach: participants">
                    <h3 data-bind="text: participantName"></h3>
                    <ul data-bind="foreach: uploads">
                        <li><span data-bind="text: fileName + ' - ' + comment"></span><span data-bind="click: $root.remove" class="glyphicon glyphicon-trash"></span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

[/@dws.skin]

