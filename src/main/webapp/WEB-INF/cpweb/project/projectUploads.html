[#ftl strip_text="true" /]

[#import "projectInfo.html" as pInfo /]

[#assign cpweb_head]
${cpweb_head}

[/#assign]

[#assign cpweb_foot ]
${cpweb_foot}
<script>
    "use strict";
    $('#menu-projects').addClass('active');

    var settings = {
        listUploadsUrl: "${helper.urlFor('project.upload.UploadJsModule', 'listUploads',[prj.projectId])}"
    };

    require(['knockout', 'messenger', 'es6-shim'], function(ko) {
        $.getJSON(settings.listUploadsUrl).done(function(data) {
            console.log("Alright we got ", data.result);
            function UploadModel() {
                this.remove = function(){
                    var upload = this;
                  console.log("Removing upload: ", upload);
                };
                this.uploadComponents = ko.observableArray([{ title: 'This is a component', participants: data.result} ]);
            }
            var model = new UploadModel();
            ko.applyBindings(model, $("#downloads-container")[0])

            if(data.status == "ok") {
                var $list = $("<ul/>")
                data.result.forEach(function(participant){
                    var $entry = $("<li/>").text(participant.participantName);
                    if(participant.uploads) {
                        console.log("uploads:", participant.uploads);
                        var $uploadEntry = $("<ul/>");
                        participant.uploads.forEach(function(upload){
                            console.log("...");
                           $uploadEntry.append($("<li/>").html(upload.fileName + ' <span class="glyphicon glyphicon-trash"></span>'));
                        });
                        $entry.append($uploadEntry);
                    }
                    $list.append($entry);
                    console.log("Participant:", participant, $entry);

                });
//                $("#downloads-container").html($list);

            }
        }).fail(function(jqXHR, textStatus, errorThrown){
            console.log("Could not fetch uploads: ", errorThrown);
            CCBMessengerError("Could not fetch uploaded files.");
        });
    });

</script>


[/#assign]

[#assign title = (prj.name!'') + " uploads ("+orgName+")" /]
[@dws.skin skin="CPAuth3" head=cpweb_head ctxMenu=cpweb_ctxMenu foot=cpweb_foot orgName=title]

[@pInfo.projectInfo selected="uploads"][/@pInfo.projectInfo]


<h1>[@dws.txt key="cpweb.project.uploads.title" /]</h1>

<form method="POST" action="{helper.urlFor('project.ProjectModificationModule','assignRoleEmail',[prj.projectId])}" class="form">
    <div class="form-group">
        [@modal.formParams /]
        <button type="submit" class="btn btn-primary">A random button</button>
    </div>
</form>

<div class="row">
    <div class="col-sm-12">
        <div id="downloads-container">
            <div data-bind="foreach: uploadComponents">
                <h2 data-bind="text: title"></h2>
                <table>
                    <tbody data-bind="foreach: participants">
                    <tr>
                        <td data-bind="text: participantName"></td>
                        <td>
                            <ul data-bind="foreach: uploads">
                                <li><span data-bind="text: fileName + ' - ' + comment"></span><span data-bind="click: $root.remove" class="glyphicon glyphicon-trash"></span></li>
                            </ul>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

[/@dws.skin]

