[#ftl strip_text="true" /]

[#import "projectInfo.html" as pInfo /]

[#assign cpweb_head]
${cpweb_head}

[/#assign]

[#assign cpweb_foot ]
${cpweb_foot}
<script>
    "use strict";
    $('#menu-projects').addClass('active');

    var settings = {
        listUploadsUrl: "${helper.urlFor('project.upload.UploadJsModule', 'listUploads',[prj.projectId])}",
        removeUploadUrl: "${helper.urlFor('project.upload.UploadJsModule', 'removeUpload')}"
    };

    require(['knockout', 'messenger', 'es6-shim'], function(ko) {
        function UploadModel() {
            var self = this;
            this.initializing = ko.observable(true);
            this.uploadComponents = ko.observableArray();
            this.remove = function(upload, parent){
                $.post(settings.removeUploadUrl, { participationId: upload.participationId, uploadId: upload.uploadId}).done(function(data){
                    if(data.status == "ok") {
                        var index = parent.uploads.indexOf(upload);
                        if(index != -1) {
                            parent.uploads.splice(index, 1);
                        }
                        CCBMessengerInfo("Upload deleted.");
                    } else {
                        CCBMessengerError("Could not delete upload.");
                    }
                }).fail(function(){
                    CCBMessengerError("Could not delete upload.");
                });
            };
            this.downloadUrl = function(){
                var uploadId = this.uploadId, participationId = this.participationId;
                var url = settings.downloadUrl + "/" + participationId + "/" + uploadId;
                return url;
//                    window.open(url, "_blank");
            };
        }
        var model = new UploadModel();
        ko.applyBindings(model, $("#downloads-container")[0])

        $.getJSON(settings.listUploadsUrl).done(function(data) {

            if(data.status == "ok") {
                // Knockout can't handle hashes, so lets restructure the data from
                // hash to array of hash with name and value.
                // TODO: I sort in cid and userId, should be names or possibly a counter.
                var components = Object.keys(data.result).sort().map(function(cid){
                    var componentMap = data.result[cid];
                    return {
                        cid: cid, componentName: componentMap.componentName,
                        participants: Object.keys(componentMap.component).sort().map(function(userId){
                            var component = componentMap.component;
                            return {
                                participantName: component[userId].participantName,
                                uploads: ko.observableArray(component[userId].uploads)
                            }
                        })
                    };
                });
                model.uploadComponents(components);
                model.initializing(false);
            } else {
                console.log("Could not fetch uploads: " + data.message);
                CCBMessengerError("Could not fetch uploaded files.");
            }
        }).fail(function(jqXHR, textStatus, errorThrown){
            console.log("Could not fetch uploads: ", errorThrown);
            CCBMessengerError("Could not fetch uploaded files.");
        });
    });

</script>


[/#assign]

[#assign title = (prj.name!'') + " uploads ("+orgName+")" /]
[@dws.skin skin="CPAuth3" head=cpweb_head ctxMenu=cpweb_ctxMenu foot=cpweb_foot orgName=title]

[@pInfo.projectInfo selected="uploads"][/@pInfo.projectInfo]


<h1>[@dws.txt key="cpweb.project.uploads.title" /]</h1>

<div class="row">
    <div class="col-sm-12">
        <div id="downloads-container">
            <!-- ko if: initializing -->
            <span>Loading...</span>
            <!-- /ko -->

            <!-- ko ifnot: initializing -->
            <!-- ko if: uploadComponents().length == 0 -->
            <em>There are no uploads in this project</em>
            <!-- /ko -->
            <!-- ko if: uploadComponents().length != 0 -->
            <div data-bind="foreach: uploadComponents">
                <h1 data-bind="text: componentName"></h1>
                <div data-bind="foreach: participants">
                    <h3 data-bind="text: participantName"></h3>
                    <!-- ko if: uploads().length == 0 -->
                    <em>No uploads</em>
                    <!-- /ko -->
                    <!-- ko if: uploads().length != 0 -->
                    <div class="list-group" data-bind="foreach: uploads">
                        <span class="list-group-item">
                            <!-- ko if: downloadUrl -->
                            <a data-bind="attr: { href: downloadUrl }, text: fileName"></a>
                            <!-- /ko -->
                            <!-- ko ifnot: downloadUrl -->
                            <span data-bind="text: fileName"></span>
                            <!-- /ko -->
                            <span data-bind="text: comment"></span>
                            <span data-bind="click: function(){$root.remove($data, $parent);}" class="glyphicon glyphicon-trash"></span>
                        </span>
                    </div>
                    <!-- /ko -->
                </div>
            </div>
            <!-- /ko -->
            <!-- /ko -->

        </div>
    </div>
</div>

[/@dws.skin]

