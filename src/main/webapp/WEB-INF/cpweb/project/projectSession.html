[#ftl strip_text="true" /]

[#import "projectInfo.html" as pInfo /]

[#assign cpweb_head]
${cpweb_head}

<!--[if lt IE 9]>
<style>

    .toggle-button input {
        position: static; !important
    }

</style>


<![endif]-->
[/#assign]

[#assign cpweb_foot ]
${cpweb_foot}

<script id="setExpirationDialogTemplate" type="text/x-jsrender">
    <div id="setExpirationDialog" title="Set Standard Expiration ">
        <p>Set the standard time for expirations in this project. Expiration will start counting downwards once the participants has been activated.</p>
        <input id="expirationToggleSetter" type="number" />

    </div>
</script>

<script>

    "use strict";
    $('#menu-projects').addClass('active');

    var settingsUrl = "${helper.urlFor('project.ProjectSettingsJsonModule', 'changeSetting',[prj.projectId])}";
    var sessionUrl = "${helper.urlFor('project.ProjectSettingsJsonModule', 'changeSetting',[prj.projectId])}";

    require(['${contextPath}/js/cpweb.js', 'select2-4.min', 'cocobox-editable'], function() {

        // Enroll section
        $('#enrollmentMode select').select2({
            data: [{id: 0, text: "Off"}, {id: 1, text: "Direct"}, {id: 2, text: "Moderated"}],
            allowClear: false,
            delay: 250,
            minimumResultsForSearch: Infinity
        }).val(2).trigger("change").ccbEditable({ // TODO: Dig out proper val
            update: function (element) {
                return $.ajax({
                    dataType: "json",
                    method: "POST",
                    url: "{updateParentUrl}",
                    data: {pk: "{cf.id}", value: $(element).val()}
                });
            }
        });

        cpweb.editable($('#enrollmentFromDate .editable-content'),
                $('#enrollmentFromDate .edit '),
                function(value){},
                {type: 'date',
                    'url': sessionUrl,
                    'pk': 'participationexpiration',
                    'value': "${((session.enrollment.fromDate)?c)!''}"
                });

        cpweb.editable($('#enrollmentToDate .editable-content'),
                $('#enrollmentFromDate .edit '),
                function(value){},
                {type: 'date',
                    'url': sessionUrl,
                    'pk': 'enrollmentFromDate',
                    'value': "${((session.enrollment.toDate)?c)!''}"
                });


        // Disenroll section
        $('#disenrollmentMode select').select2({
            data: [{id: 0, text: "Off"}, {id: 1, text: "Direct"}, {id: 2, text: "Moderated"}],
            allowClear: false,
            delay: 250,
            minimumResultsForSearch: Infinity
        }).val(2).trigger("change").ccbEditable({ // TODO: Dig out proper val
            update: function (element) {
                return $.ajax({
                    dataType: "json",
                    method: "POST",
                    url: "{updateParentUrl}",
                    data: {pk: "{cf.id}", value: $(element).val()}
                });
            }
        });


        cpweb.editable($('#disenrollmentFromDate .editable-content'),
                $('#disenrollmentFromDate .edit '),
                function(value){},
                {type: 'date',
                    'url': sessionUrl,
                    'pk': 'participationexpiration',
                    'value': "${((session.disenrollment.fromDate)?c)!''}"
                });

        cpweb.editable($('#disenrollmentToDate .editable-content'),
                $('#disenrollmentFromDate .edit '),
                function(value){},
                {type: 'date',
                    'url': sessionUrl,
                    'pk': 'disenrollmentFromDate',
                    'value': "${((session.disenrollment.toDate)?c)!''}"
                });

    });



    $(function(){
        require(['dabox-common', '${contextPath}/js/project/projectCommon.js?${cycle.application.formattedStartTime.base36String}'], function() {
            //cocobox.setlist.expandableList('#settingsList');
        });
    });

    var setIcal = function(autoIcal, sendUpdates) {
        $("#meeting-maker-cb").bootstrapToggle('disable');
        $.ajax({
            type: 'POST',
            url: "${helper.urlFor('project.ProjectJsonModule','setAutoIcalStatus',[prj.projectId])}",
            data: {autoical: autoIcal, sendUpdates: sendUpdates},
            success: function(data) {
                $("#meeting-maker-cb").bootstrapToggle('enable');
                $("#meeting-maker-cb").bootstrapToggle(autoIcal ? 'on' : 'off');
                log(data);
            },
            complete: function() {
                $("#meeting-maker-cb").bootstrapToggle('enable');
            }
        });
    };

    var setSocial = function(socialSetting) {

        $.ajax({
            type: 'POST',
            url: "${helper.urlFor('project.ProjectJsonModule','setSocialSetting',[prj.projectId])}",
            data: {enabled: socialSetting},
            success: function(data) {
                $('#socialfeatures-cb').bootstrapToggle('enable');
                $('#socialfeatures-cb').bootstrapToggle(socialSetting ? 'on' : 'off');
            },
            complete: function() {
                $('#socialfeatures-cb').bootstrapToggle('enable');
            }
        });
    };

    var setProgressVisibility = function(visibility) {

        $.ajax({
            type: 'POST',
            url: "${helper.urlFor('project.ProjectJsonModule','setProgressVisibility',[prj.projectId])}",
            data: {enabled: visibility},
            success: function(data) {
                $('#progressVisible-cb').bootstrapToggle('enable');
                $('#progressVisible-cb').bootstrapToggle(visibility ? 'on' : 'off');
            },
            complete: function() {
                $('#progressVisible-cb').bootstrapToggle('enable');
            }
        });
    };



    //onload and require is important. This code must run after toggle buttons are initialized
    $(function() {
        require(['bootstrap/toggle'], function() {

            $('#meeting-maker-h').next().on('click', function(ev, st) {
                var clicked = !$("#meeting-maker-cb").prop("checked");

                if(clicked) {
                    cocobox.confirmationDialog(
                            'Turning calendar invitations ON',
                            'As you turn this feature on, all participants will automatically receive calendar invitations via email, both as events are added, updated and deleted.' ,
                            function() {
                                setIcal(true, false);
                            }
                    );
                } else {
                    cocobox.confirmationDialogYesNo(
                            'Turning calendar invitations OFF',
                            'Do you want to send cancellations to previously sent calendar invitations?',
                            function () {
                                //log('Send cancels');
                                setIcal(false, true);
                            },
                            function () {
                                //log('No cancels');
                                setIcal(false, false);
                            }
                    );
                }

                return false;
            });

            $('#socialfeatures-h').next().on('click', function (ev) {
                $('#socialfeatures-cb').bootstrapToggle('disable');
                setSocial(!$("#socialfeatures-cb").prop("checked"));
                return false;
            });
            $('#progressVisible-h').next().on('click', function (ev) {
                $('#progressVisible-cb').bootstrapToggle('disable');
                setProgressVisibility(!$("#progressVisible-cb").prop("checked"));
                return false;
            });
        });
    });

    $('#expirationtoggle-false').click(function() {
        $.ajax({
            type: "POST",
            url: settingsUrl,
            data: {
                pk: 'participationexpiration',
                value: 0
            }
        });
    });

    $('#expirationtoggle-true').click(function() {
        require(['jsrender'], function() {
            $('body').append($('#setExpirationDialogTemplate').render());

            $('#setExpirationDialog').dialog({
                title: "Set expiration",
                buttons: {
                    "Set": function() {
                        $.ajax({
                            type: "POST",
                            url: settingsUrl,
                            data: {
                                pk: 'participationexpiration',
                                value: $('#expirationToggleSetter').val()
                            },
                            success: function() {
                                $('#setExpirationDialog').dialog('close');
                                window.location.reload();
                            }
                        });
                    }
                }
            });
        });

    });
</script>

[/#assign]



[#assign title = (prj.name!'') + " session ("+orgName+")" /]
[@dws.skin skin="CPAuth3" head=cpweb_head ctxMenu=cpweb_ctxMenu foot=cpweb_foot orgName=title]

[@pInfo.projectInfo selected="session"][/@pInfo.projectInfo]

<section class="ccb-expandable-list">
    <h1>[@dws.txt key="cpweb.project.session.section.information.title" /]</h1>
    <div id="settingsList">
        <ul>
            <li id="language">
            <span class="setting">
                <span class="row-label">[@dws.txt key="cpweb.project.session.description.title" /]</span>
                <span class="short editable-content"></span>
            </span>
            </li>
        </ul>
    </div>
</section>
<section class="ccb-expandable-list">
    <h1>[@dws.txt key="cpweb.project.session.section.visibility.title" /]</h1>
    <div id="settingsList">
        <ul>
            <li id="visible">
                <a class="setting">
                    <span class="row-label">[@dws.txt key="cpweb.project.session.visibility.title" /]</span>
                    [@bsform.inputBoolean 'visible' 'Visible in course catalog' 'ON' 'OFF' false?string session=formsess /]
                </a>
            </li>
            <li id="showName">
                <a class="setting">
                    <span class="row-label">[@dws.txt key="cpweb.project.session.showNames.title" /]</span>
                    [@bsform.inputBoolean 'showName' 'Show names in course catalog' 'ON' 'OFF' false?string session=formsess /] <!-- false -> something like prj.showVisible -->
                </a>
            </li>
            <li id="showThumbnails">
                <a class="setting">
                    <span class="row-label">[@dws.txt key="cpweb.project.session.showThumbnails.title" /]</span>
                    [@bsform.inputBoolean 'showThumbnails' 'Show thumbnails in course catalog' 'ON' 'OFF' false?string session=formsess /] <!-- false -> something like prj.showVisible -->
                </a>
            </li>
        </ul>
    </div>
</section>
<section class="ccb-expandable-list">
    <h1>[@dws.txt key="cpweb.project.session.section.enrollment.title" /]</h1>
    <div id="settingsList">
        <ul>
            <li id="enrollmentMode">
            <span class="setting">
                <span class="row-label">[@dws.txt key="cpweb.project.session.enrollment.mode.title" /]</span>
                <select style="width: 150px"></select>
            </span>
            </li>
            <li id="enrollmentFromDate">
            <span class="setting">
                <span class="row-label">[@dws.txt key="cpweb.project.session.enrollment.mode.title" /]</span>
                <span class="short editable-content">${(session.enrollment.fromDate)!'Click to set enrollment start date'}</span>
            </span>
            </li>
            <li id="enrollmentToDate">
            <span class="setting">
                <span class="row-label">[@dws.txt key="cpweb.project.session.enrollment.mode.title" /]</span>
                <span class="short editable-content">${(session.enrollment.toDate)!'Click to set enrollment end date'}</span>
            </span>
            </li>
        </ul>
    </div>
</section>

<section class="ccb-expandable-list">
    <h1>[@dws.txt key="cpweb.project.session.section.disenrollment.title" /]</h1>
    <div id="settingsList">
        <ul>
            <li id="disenrollmentMode">
            <span class="setting">
                <span class="row-label">[@dws.txt key="cpweb.project.session.disenrollment.mode.title" /]</span>
                <select style="width: 150px"></select>
            </span>
            </li>
            <li id="disenrollmentFromDate">
            <span class="setting">
                <span class="row-label">[@dws.txt key="cpweb.project.session.disenrollment.mode.title" /]</span>
                <span class="short editable-content">${(session.disenrollment.fromDate)!'Click to set disenrollment start date'}</span>
            </span>
            </li>
            <li id="disenrollmentToDate">
            <span class="setting">
                <span class="row-label">[@dws.txt key="cpweb.project.session.disenrollment.mode.title" /]</span>
                <span class="short editable-content">${(session.disenrollment.toDate)!'Click to set disenrollment end date'}</span>
            </span>
            </li>
        </ul>
    </div>
</section>

[/@dws.skin]

