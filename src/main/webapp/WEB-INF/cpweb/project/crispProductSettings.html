[#ftl strip_text="true" /]

[#assign editMode = false /]

[#macro settingsList config]
        [#list config as productConfig]
            [@productSettings productConfig /]
        [/#list]
[/#macro]

[#macro productSettings productConfig productNameMap=productNameMap]
    <h1>${productNameMap[productConfig.productId]?xml}</h1>

    [@listSettings productConfig.projectConfig.items productConfig.productId /]

    [#if productConfig.projectConfig.advancedItems?size > 0]
        <h2>Advanced settings</h2>
        [@listSettings settings=productConfig.projectConfig.advancedItems productId=productConfig.productId prefix="adv"/]
    [/#if]

[/#macro]

[#macro listSettings settings productId prefix="p"]

   [#list settings as setting]
    <div class="form-group">
      <label for="${prefix}${setting?index}">${setting.title?xml}</label>

      [@settingBox setting]

        [#if editMode]
            <span data-type="text"
                  data-pk="${productId?xml}"
                  data-url="/post"
                  data-title="${(setting.description?xml)!''}"
                  data-name="${setting.id?xml}"
                >

            </span>

        [#else]
            <input type="${crispTypeMapping[setting.type]}"
                   data-crisptype="${setting.type}"
                   class="form-control"
                   id="${prefix}${setting?index}"
                   name="${productId?xml}-${setting.id?xml}"
                   placeholder="${(setting.description?xml)!''}"
                   aria-describedby="${prefix}${setting?index}HelpBlock"
                   [#if !setting.optional && setting.type != "toggle"]required="required"[/#if]
                   />
        [/#if]
      [/@]

      <span id="${prefix}${setting?index}HelpBlock" class="help-block">${(setting.description?xml)!''}</span>
    </div>
   [/#list]
[/#macro]

[#macro settingBox setting]
    [#if setting.type == "toggle"]
        <p class="form-control-static">
    [/#if]
    [#nested /]
    [#if setting.type == "toggle"]
        </p>
    [/#if]
[/#macro]


[#macro javascriptFootContribution ]
    <script>
        [#if editMode]
            require(['bootstrap/editable','cocobox-togglebutton','cocobox-editable-date','cocobox-editable-datetime'], function(jqe, b) {

                $("span[data-type]").editable();

                $("input[data-crisptype=toggle]").each(function() {
                    tb.initToggle(this);
                });
            });

        [#else]
            require(['cocobox-date', 'cocobox-datetime', 'cocobox-togglebutton'], function(d, dt, tb) {
                $("input[data-crisptype=date]").each(function() {
                    d.dateTime(this);
                });

                $("input[data-crisptype=datetime]").each(function() {
                    dt.dateTime(this);
                });

                $("input[data-crisptype=toggle]").each(function() {
                    tb.initToggle(this);
                });
            });

        [/#if]

        var crispProductSettings = crispProductSettings || {};

        crispProductSettings.isAllValid = function() {
            var fields = $("input[data-crisptype");

            var valid = 0;
            fields.each(function() {
                var required = $(this).prop("required");
                if (!required) {
                    valid++;
                    return;
                }

                if ($(this).attr("data-crisptype") === "toggle") {
                    valid++;
                } else {
                    if ($(this).val()) {
                        valid++;
                    }
                }
            });

            return fields.length === valid;
        };

    </script>
[/#macro]

[#assign crispTypeMapping = {   "string": "text",
                                "integer": "number",
                                "date": "hidden",
                                "datetime": "hidden",
                                "toggle": "checkbox",
                                "email": "email",
                                "url": "url"
                            } /]

