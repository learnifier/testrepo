[#ftl strip_text="true" /]

[#import "bounceInfo.html" as bInfoRender /]
[#import "projectInfo.html" as pInfo /]

[#assign foot]

[@bInfoRender.bRenderer][/@bInfoRender.bRenderer]

${cpweb_foot}

[#include "jsr_progressinfoTemplate.inc"]
[#include "jsr_adminlinkTemplate.inc"]
[#include "jsr_reportinfoTemplate.inc"]
[#include "jsr_detailsTable.inc"]
[#include "jsr_invitesTemplate.inc"]
[#include "jsr_expirationSetterDialog.inc" /]
[#include "jsr_expirationAdjustDialog.inc" /]


<script>
    $('#tm_projects').addClass('activeItem').prev().addClass('prevItem');


    function runiCheck() {
      $('input').iCheck({
        checkboxClass: 'icheckbox_square-red',
        radioClass: 'iradio_square-red'
      });
    };
</script>


<script>
    $(document).ready(function() {
        require(['dataTables-bootstrap', 'jquery.timeago', 'cocobox-icheck'], function() {
            window.oTable = $('#projectroster').DataTable({
                dom: 'rt<"dataTables_footer clearfix"i>',
                paging: false,
                order: [[2, 'asc']],
                createdRow: function(nRow, oObj, iDisplayIndex, iDisplayIndexFull) {
                    if (oObj.inError) {
                        $(nRow).addClass('error');
                        $(nRow).find('td').css('background', 'rgba(255,0,0,0.1)');
                        return nRow;
                    } else if (!oObj.activated) {
                        $(nRow).addClass('inactive');
                        $(nRow).css('opacity', '0.6');
                        return nRow;
                    }
                    else if (oObj.expired) {
                        $(nRow).attr('title', 'This participation has expired');
                        $(nRow).addClass('expired');
                        return nRow;
                    }
                },
                initComplete: function() {
                    log('DataTables has finished its initialisation.');
                    showRow();
                    $('.timeago').timeago();
                    $('[data-toggle="tooltip"]').tooltip()                    
                    runiCheck();
                },
                columnDefs: [
                    {
                        targets: [0],
                        data: "id",
                        orderable: false,
                        width: "24px",
                        render: function(data) {
                            return  '<input type="checkbox" class="rowcb" onchange="return cpweb.rowcbChange(this)" data-rowid="' + data + '"/>';
                        }
                    },
                    {
                        "aTargets": [1],
                        "mData": "participationLink",
                        "bSortable": false,
                        "sWidth": 16,
                        "fnRender": function(oObj) {
                            if (oObj.aData.inError) {
                                var msg = oObj.aData.errorMsg;
                                if (msg == null) {
                                    msg = 'Participation error reason is not known';
                                }

                                window.partError = window.partError || {};

                                window.partError[oObj.aData.id] = msg;

                                var onclick = "onclick='showRosterPartErrorBox(window.partError[" + oObj.aData.id + "])'";

                                var data = '<img src="${cocoboxCdn}/cocobox/img/cp/participation_error.png" ' + onclick + ' class="participationTriangle" alt="Participation Link"/>';

                                return data;
                            } else if (oObj.aData.activated) {
                                var data = '<a href="" onclick="cocobox.infoDialog(\'Participation access link\', \'' + oObj.aData.participationLink + '\'); return false"><span class="glyphicon glyphicon-link" aria-hidden="true"></span></a>';
                                
                                return data;
                            }

                            return '';
                        }
                    },
                    {
                        "aTargets": [2],
                        "mData": "displayName",
                        "sWidth": 250,
                        "useRendered": false,
                        "fnRender": function(oObj) {
                            var data = '<a class="name" href="' + oObj.aData.link + '" title="' + oObj.aData.email + '">' + oObj.aData.displayName + '</a> ';

                            [@projectSecurity.permissionBlock permission="PRJ_IMPERSONATE_PARTICIPANT"]
                            if (oObj.aData.activated && !oObj.aData.inError) {
                                data += '<a class="impersonate-link" target="_blank" title="Visit Learner Portal as '
                                        + oObj.aData.displayName
                                        + '" href="${helper.urlFor('ProjectModule','impersonate')}/'
                                        + oObj.aData.id
                                        + ' "><span class="glyphicon glyphicon-new-window" aria-hidden="true"></span></a>';
                            }
                            [/@]
                            return data;
                        }
                    },
                    {
                        "aTargets": [3],
                        "mData": "firstEmail",
                        "fnRender": function(oObj) {
                            if (oObj.aData.firstEmailStr) {
                                return  oObj.aData.firstEmailStr;
                            } else if (oObj.aData.sending && !oObj.aData.firstEmailStr) {
                                return  "Sending...";
                            } else {
                                return null;
                            }
                        }
                    },
                    {
                        "aTargets": [4],
                        "mData": "lastEmail",
                        "fnRender": function(oObj) {
                            if (oObj.aData.sending) {
                                return "Sending..."
                            } else if (oObj.aData.bounced) {
                                return '<a href="#" onclick="showBounceInfo(' + oObj.aData.id + '); return false" class="bouncealert" title="' + oObj.aData.lastEmailStr + '">Bounced back</a>';
                            } else {
                                return  oObj.aData.lastEmailStr;
                            }
                        }
                    },
                    {
                        "aTargets": [5],
                        "mData": "lastAccess",
                        "fnRender": function(oObj) {

                            if (oObj.aData.lastAccess) {
                                return '<abbr class="timeago" title="' + oObj.aData.lastAccessAgo + '">' + oObj.aData.lastAccessStr + '</abbr>';
                            } else {
                                return 'Not yet logged in';
                            }
                        }
                    },
                    {
                        "aTargets": [6],
                        "mData": "status",
                        "sWidth": 120,
                        "fnRender": function(oObj) {
                            return  '<div class="progress"><div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="' + oObj.aData.status + '" aria-valuemin="0" aria-valuemax="100" style="width:' + oObj.aData.status +
                                    '%;"></div</div>';
                        }
                    },
                    {
                        "aTargets": [7],
                        "mData": null,
                        "bSortable": false,
                        "useRendered": false,
                        "sWidth": 25,
                        "fnRender": function(oObj) {

                            return '<span class="pe-7s-angle-down-circle expand"></span>';

                        }
                    }
                ],
                "sAjaxSource": "${helper.urlFor('ProjectJsonModule','projectRoster', [prj.projectId?c])}",
                "oLanguage": {
                    "sEmptyTable": "<span class='emptytable'>The roster is empty. Add a participant above to get started. </span>",
                    "sLoadingRecords": "<p>Loading roster...</p><img src='${contextPath}/img/spinner-threedots.gif' />"
                }
            });
        });

        cpweb.registerListform($("#projectrosterform").first());
        $('#listprojects_filter input').attr('placeholder', 'Search for projects');

        $.fn.clearForm = function() {
            return this.each(function() {
                var type = this.type, tag = this.tagName.toLowerCase();
                if (tag == "form")
                    return $(":input", this).clearForm();
                if (type == "text" || type == "email")
                    this.value = "";
            });
        };

        [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_ROSTER"]
        require(['jquery.form', 'dabox-common', 'dabox-formbeanjs'], function() {
            $("#uploadRoster").ajaxForm(cocobox.getAjaxFormbeanHandler("uploadRoster"));
        });
        [/@]

        $("#cball").click(function(ev) {
            if (this.checked) {
                var items = $("input.rowcb").not(":checked");
                items.trigger('click');
                //Trigger change so that IE8- picks up the change
                items.trigger('change');
            } else {
                var items = $("input.rowcb").filter(":checked");
                items.trigger('click');
                //Trigger change so that IE8- picks up the change
                items.trigger('change');
            }
        })

        $("#projectrosterform").submit(cpweb.projectRosterListForm);


    });



    var fetchAndInjectDetails = function(detailsData, injectInRow) {
        var ajaxCallUrl = detailsData.detailsUrl;

        cocobox.ajaxPost(ajaxCallUrl, {
            success: function(data) {
                $(injectInRow).empty();
                $(injectInRow).removeClass('loading');

                var expirationStr = detailsData.expirationStr;
                var expirationAgo = detailsData.expirationAgo;
                var expired = detailsData.expired;
                
                var completed = 0;
                for (var i = 0; i < data.progress.length; i++) {
                    if (data.progress[i].completed) {
                        completed++;
                    }
                    data.progress.completed = completed;
                }

                if (data.reports.length == 0) {
                    data.reports.push({empty: true});
                } else {

                    for (var i = 0; i < data.reports.length; i++) {
                        if (data.reports[i].type == 'application/pdf') {
                            data.reports[i].filetype = data.reports[i].type.split('application/').join('');
                        }

                    }
                }

                var renderedProgress = $('#progressTemplate').render(data.progress);
                var renderedReports = $('#reportinfoTemplate').render(data.reports);
                var renderedAdminlinks = $('#adminlinkTemplate').render(data.adminlinks);
                var renderedInvites = $('#invitesTemplate').render(data.idprojects);


                $(injectInRow).append($('#detailsTable').render({
                    renderedProgress: renderedProgress,
                    completedCids: completed,
                    totalnumberOfCidsWithProgress: data.progress.length,
                    renderedReports: renderedReports,
                    renderedAdminlinks: renderedAdminlinks,
                    renderedInvites: renderedInvites,
                    expired: expired,
                    expirationStr: expirationStr,
                    expirationAgo: expirationAgo
                }));
                
                jQuery.timeago.settings.allowFuture = true;
                $(injectInRow).find('.timeago').timeago();
                //Hide invite section if no invites
                if (renderedInvites.len < 1) {
                    $('.invites').hide();
                }
            }
        });
    };

    var showRow = function() {
        require(['dataTables-bootstrap', 'jsrender'], function() {
            var oTable = $('#projectroster').dataTable();
            var detailsData = {};

            $('.expand').click(function() {

                var parentTd = $(this).parent()[0];
                var clickedRow = $(parentTd).parent()[0];

                var aoData = oTable.fnGetData(clickedRow);
                
                log('this is the data for the clicked row', aoData);
                
                //attach the expirationDetails
                detailsData.expirationStr = aoData.expirationStr;
                detailsData.expirationAgo = aoData.expirationAgo;
                detailsData.expired = aoData.expired;
                
                detailsData.detailsUrl = aoData.detailsUrl;

                $(this).toggleClass('pe-7s-angle-down-circle');
                $(this).toggleClass('pe-7s-angle-up-circle');
                $(clickedRow).toggleClass('expanded');

                if (oTable.fnIsOpen(clickedRow)) {
                    oTable.fnClose(clickedRow);
                } else {
                    var injectInContainer = $('<div>');

                    oTable.fnOpen(clickedRow, injectInContainer, "details");
                    $(injectInContainer).attr('class', 'loading');

                    if (aoData.inError) {
                        $(injectInContainer).html('<p>Sorry, but something went wrong as we were setting up this participant. Try fixing this by either sending an email to ' + aoData.displayName + ' or by using the "Activate" functionality. If that does not do it, please reach out to tech support.');

                        if (aoData.bounced) {
                            $(injectInContainer).append('<p>The last email sent to ' + aoData.displayName + ' bounced back. Please check the email address and resend the email. </p>');
                        }

                    } else if (!aoData.activated) {
                        $(injectInContainer).html('<p>Invite the participant to see details here. </p>');

                    } else {
                        $(injectInContainer).attr('class', 'loading');
                        $(injectInContainer).html('<img src="${cocoboxCdn}/cocobox/img/loading.gif" alt="spinner"/>');
                        $(injectInContainer).attr('class', 'loading detailscontainer');
                        fetchAndInjectDetails(detailsData, injectInContainer);
                    }

                }

            });
        });
    };



    function showBounceInfo(strPartId) {
        cocobox.ajaxPost("${helper.urlFor('ProjectJsonModule','participationBounceInfo')}/" + strPartId, {
            success: showBounceDialog
        });
    }
    function showBounceDialog(data) {
        var bDialog = $("#bounceinfo").render(data);
        $(bDialog).dialog({
            width: 800,
            height: 600,
            modal: true,
            resizable: true
        });
    }

    function addMemberListener() {
        require(['dabox-common', 'dabox-jquery'], function() {
            cocobox.longOp();
            $(".save").cocobox('inputBlock');
        });
        return true;
    }

    $('#memberemail').keyup(function() {
        log($('#memberemail').val());
    });


    var impersonateBaseUrl = "${helper.urlFor('ProjectModule','impersonate')}";
    
    function impersonate(participationId) {
        window.location.href = impersonateBaseUrl+'/'+participationId;
        return false;
    }

</script>
<!-- Temporary for iCheck-->
[/#assign]

[#assign cpweb_head]
${cpweb_head}
<!--[if lte IE 8]>
<script src="${cocoboxCdn}/cocobox/js/excanvas/excanvas.compiled.js"></script>
<![endif]-->
[/#assign]

[@dws.skin skin="CPAuth3" head=cpweb_head ctxMenu=cpweb_ctxMenu foot=foot orgName=orgName]

[#include "../allocationFailure.html" /]

[@pInfo.projectInfo selected="participants"][/@pInfo.projectInfo]


[@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_ROSTER"]
<div role="tabpanel">

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#manual" aria-controls="manual" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-pencil"></span> Manual</a></li>
    <li role="presentation"><a href="#uploadroster" aria-controls="uploadroster" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-cloud-upload" aria-hidden="true"></span> Upload</a></li>
    [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_SELFREG"]
    <li role="presentation"><a href="#selfreg" aria-controls="selfreg" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> Self-Registration <span class="badge">OFF</span></a></li>
    [/@]
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane fade in active" id="manual">
        <section id="addtoroster">
            <div>
                [#global formPrefix="cpweb" /]
                <form action="${helper.urlFor('ProjectModificationModule','addMember',[prj.projectId?c])}" name="addMemberForm" id="addMemberForm" class="fullpage" method="post" onsubmit="return addMemberListener()">
                    <section class="field">
                        [@mbform.inputText name="memberfirstname" class=""  tabindex="2" maxlength="64" /]
                        [@mbform.inputText name="memberlastname" class=""  tabindex="3" maxlength="64" /]
                        [@mbform.inputEmail name="memberemail" class=""  tabindex="4" maxlength="96" /]
                    </section>
                    <section class="action">
                        <button type="submit" tabindex="100" class="btn btn-primary"><span class="glyphicon glyphicon-plus-sign"></span> [@dws.txt key='form.action.addmember' /]</button>
                    </section>  
                </form>
            </div>
        </section>
                
    </div>
    <div role="tabpanel" class="tab-pane fade" id="uploadroster">
      [#include "rosterUpload.html" /]
    </div>
    [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_SELFREG"]
    <div role="tabpanel" class="tab-pane fade" id="selfreg">Do the selfreg</div>
    [/@]
  </div>

</div>

[/@]

<form method="post" id="projectrosterform" action="${helper.urlFor('ProjectModificationModule','listCommand')}">
    [@mbform.listformFields /]
    <input type="hidden" name="projectId" value="${prj.projectId?c}" />
    <input id="expirationdate" type="hidden" name="expirationdate" value="" />
    <input id="adjusteddate" type="hidden" name="expirationadjustment" value="" />
    
    <section class="listactions">
        [@projectSecurity.permissionBlock permission="CP_SEND_MAIL_PROJECT"]
        <button class="btn btn-primary btn-sm" onclick="cpweb.runListCommand(this, $('#projectrosterform'), 'send');        
                return false" ${prj.invitePossible?string('','disabled="disabled"')}><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Send Email...</button>
        [/@]
        [@portalSecurity.permissionBlock permission="PRJ_CHANGE_EXPIRATION"]
        <button class="btn btn-primary-outlined btn-sm" onclick="cpweb.setExpiration(this, $('#projectrosterform'), 'setExpiration'); return false"><span class="glyphicon glyphicon-dashboard"></span> Set Expiration</button>
        [/@]
        [@portalSecurity.permissionBlock permission="PRJ_CHANGE_EXPIRATION"]
        <button class="btn btn-primary-outlined btn-sm" onclick="cpweb.adjustExpiration(this, $('#projectrosterform'), 'adjustExpiration');        
                return false"><span class="glyphicon glyphicon-time"></span> Adjust Expiration</button>
        [/@]
        [@projectSecurity.permissionBlock permission="PRJ_ACTIVATE_PARTICIPANT"]
            <button class="btn btn-primary-outlined btn-sm" onclick="cpweb.runListCommand(this, $('#projectrosterform'), 'activate');
                    return false" ${prj.invitePossible?string('','disabled="disabled"')} ><span class="glyphicon glyphicon-flash"></span> Activate</button>
        [/@]
        [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_ROSTER"]
        <button class="btn btn-primary-outlined btn-sm" onclick="return cpweb.rosterDelete(this, $('#projectrosterform'), 'delete', '${ctext("cpweb.project.roster.delete.title")?js_string}', '${ctext("cpweb.project.roster.delete.text")?js_string}');"><span class="glyphicon glyphicon-trash"></span> Delete</button>
        [/@]
        
        
        [#include "projectRosterCalendarActivatedSection.html" /]
    </section>

    <section class="">
        <table class="table table-striped table-hover" id="projectroster">
            <thead>
                <tr>
                    <th><input type="checkbox" id="cball"></th>
                    <th></th>
                    <th>Name</th>
                    <th>Invited</th>
                    <th>Last Email</th>
                    <th>Last Seen</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <a href="${helper.urlFor('project.ProjectJsonModule','projectRosterExcel',[prj.projectId?c,'roster-'+prj.projectId?c+'.xls'])}">Download roster as a Excel file</a>
    </section>
</form>
[#include "bounceInfo.html" /]

[#include "projectRosterParticipationErrorBox.html"]

[/@dws.skin]

