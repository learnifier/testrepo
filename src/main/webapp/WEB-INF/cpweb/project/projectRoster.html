[#ftl strip_text="true" /]

[#import "bounceInfo.html" as bInfoRender /]
[#import "projectInfo.html" as pInfo /]
[#import "projectRegistration.html" as pRegistration /]

[#assign foot]

[@bInfoRender.bRenderer][/@bInfoRender.bRenderer]

${cpweb_foot}

[#include "jsr_progressinfoTemplate.inc"]
[#include "jsr_adminlinkTemplate.inc"]
[#include "jsr_reportinfoTemplate.inc"]
[#include "jsr_detailsTable.inc"]
[#include "jsr_invitesTemplate.inc"]
[#include "jsr_expirationSetterDialog.inc" /]
[#include "jsr_expirationAdjustDialog.inc" /]
[#include "projectRosterMoveDialog.html" /]
[@pRegistration.foot /]

<script>
    $('#menu-projects').addClass('active');
    
</script>


<script id="roster-cell-action-template" type="text/x-handlebars-template">
<div class='btn-group'>
    <button type='button' class='btn btn-primary-outlined btn-sm dropdown-toggle' data-toggle='dropdown' aria-expanded='false'>Actions <span class='glyphicon glyphicon-menu-down'></span></button>
    <ul class='dropdown-menu' role='menu'>
        {{#if activated}}
        <li><a href='#' data-trigger='roster-row-action' data-action='link'><span class="glyphicon glyphicon-link"></span>  Get Link</a></li>
        {{/if}}
        {{#if impersonateAllowed}}
        <li><a href='#' data-trigger='roster-row-action' data-action='impersonate'><span class="glyphicon glyphicon-eye-open"></span>  View As</a></li>
        {{/if}}
        {{#if moveAllowed}}
        <li><a href='#' data-trigger='roster-row-action' data-action='move'><span class="glyphicon glyphicon-log-out"></span>  Move</a></li>
        {{/if}}
    </ul>
</div>   
</script>


<script>
    var impersonateLink = "";
    var impersonateEnabled = false;
    [@projectSecurity.permissionBlock permission="PRJ_IMPERSONATE_PARTICIPANT"]
        impersonateLink = "${helper.urlFor('ProjectModule','impersonate')}";
        impersonateEnabled = true;
    [/@]

    var moveLink = "";
    var moveEnabled = false;
    [@projectSecurity.permissionBlock permission="PRJ_IMPERSONATE_PARTICIPANT"]
        moveLink = "${helper.urlFor('project.move.ParticipantMoveModule','selectTarget',[prj.projectId])}";
        moveEnabled = true;
    [/@]
        
     
    $(document).ready(function() {
        require(['cocobox-handlebars', 'dataTables-bootstrap', 'jquery.timeago', 'cocobox-icheck'], function(hb) {

            var source = $("#roster-cell-action-template").html();
            var rosterCellActionTemplate = hb.compile(source);
            
            window.oTable = $('#projectroster').dataTable({
                "dom": '<"row"<"col-sm-12"rt>><"row"<"col-sm-6"i><"col-sm-6"p>>',
                "paging": false,
                "order": [[2, 'asc']],
                "createdRow": function(nRow, oObj, iDisplayIndex, iDisplayIndexFull) {
                    if (oObj.inError) {
                        $(nRow).addClass('error');
                        $(nRow).find('td').css('background', 'rgba(255,0,0,0.1)');
                        return nRow;
                    } else if (!oObj.activated) {
                        $(nRow).addClass('inactive');
                        $(nRow).css('opacity', '0.6');
                        return nRow;
                    }
                    else if (oObj.expired) {
                        $(nRow).attr('title', 'This participation has expired');
                        $(nRow).addClass('expired');
                        return nRow;
                    }
                },
                "initComplete": function() {
                    log('DataTables has finished its initialisation.');
                    showRow();
                    $('.timeago').timeago();
                    $('[data-toggle="tooltip"]').tooltip()                    
                    runiCheck();
                },
                "columnDefs": [
                    {
                        "targets": [0],
                        "data": "id",
                        "orderable": false,
                        "width": "24px",
                        "render": function(data) {
                            return  '<input type="checkbox" class="rowcb" onchange="return cpweb.rowcbChange(this)" data-rowid="' + data + '"/>';
                        }
                    },
                    {
                        "targets": [1],
                        "orderable": false,
                        "width": "16px",
                        "data" : function(row, type, set) {
                            if (!row.participationLinkDisplay) {
                                
                                if (row.inError) {
                                    var msg = row.errorMsg;
                                    if (msg == null) {
                                        msg = 'Participation error reason is not known';
                                    }

                                    window.partError = window.partError || {};
                                    window.partError[row.id] = msg;
                                    var onclick = "onclick='showRosterPartErrorBox(window.partError[" + row.id + "])'";
                                    var data = '<a" ' + onclick + ' class="btn btn-link participationTriangle" alt="Participation Link"><span class="glyphicon glyphicon-alert text-danger"></span></a>';

                                    row.participationLinkDisplay = data;
                                } else  {
                                    row.participationLinkDisplay = "";
                                }
                            } 
                            
                            if (type === 'display') {
                                return row.participationLinkDisplay;
                            } else if (type === 'filter') {
                                return row.participationLink;
                            } else if (type === 'sort') {
                                return row.participationLink;
                            } else {
                                //Anything else and raw row
                                return row.participationLink;
                            }
                        }                        
                    },
                    {
                        "targets": [2],
                        "orderable": false,
                        "width": "80px",
                        "data" : function(row, type, set) {
                            if(!row.actionsDisplay) {
                                row.impersonateAllowed = impersonateEnabled && row.activated;
                                row.moveAllowed = moveEnabled && !row.inError;
                                var html = rosterCellActionTemplate(row);
                                row.actionsDisplay = html;
                            }
                            
                            if (type === 'display') {
                                return row.actionsDisplay;
                            } else if (type === 'filter') {
                                return null;
                            } else if (type === 'sort') {
                                return null;
                            } else {
                                //Anything else and raw row
                                return row.actionsDisplay;
                            }
                        }
                    },
                    {
                        "targets": [3],
                        "width": "250px",
                        "data" : function(row, type, set) {
                            if (!row.displayNameDisplay) {
                                var data = '<a class="name" href="' + row.link + '" title="' + row.email + '">' + row.displayName + '</a> ';
                                row.displayNameDisplay = data;
                            }
                            
                            if (type === 'display') {
                                return row.displayNameDisplay;
                            } else if (type === 'filter') {
                                return row.displayName;
                            } else if (type === 'sort') {
                                return row.displayName;
                            } else {
                                //Anything else and raw row
                                return row.displayName;
                            }
                        }
                    },
                    {
                        "targets": [4],
                        "data" : function(row, type, set) {
                            if (!row.firstEmailDisplay) {
                                if (row.firstEmailStr) {
                                    row.firstEmailDisplay =  row.firstEmailStr;
                                } else if (row.sending && !row.firstEmailStr) {
                                    row.firstEmailDisplay =  "Sending...";
                                } else {
                                    return null;
                                }
                            } 
                            
                            if (type === 'display') {
                                return row.firstEmailDisplay;
                            } else if (type === 'filter') {
                                return row.firstEmailStr;
                            } else if (type === 'sort') {
                                return row.firstEmail;
                            } else {
                                //Anything else and raw row
                                return row.firstEmail;
                            }
                        }
                    },
                    {
                        "targets": [5],
                        "data" : function(row, type, set) {
                            if (!row.lastEmailDisplay) {
                                if (row.sending) {
                                    row.lastEmailDisplay = "Sending..."
                                } else if (row.bounced) {
                                    row.lastEmailDisplay = '<a href="#" onclick="showBounceInfo(' + row.id + '); return false" class="text-danger" title="' + row.lastEmailStr + '">Bounced back</a>';
                                } else {
                                    row.lastEmailDisplay = row.lastEmailStr;
                                }
                            }
                            
                            if (type === 'display') {
                                return row.lastEmailDisplay;
                            } else if (type === 'filter') {
                                return row.lastEmailStr;
                            } else if (type === 'sort') {
                                return row.lastEmail;
                            } else {
                                //Anything else and raw row
                                return row.lastEmail;
                            }
                        }
                    },
                    {
                        "targets": [6],
                        "data" : function(row, type, set) {
                            if (!row.lastAccessDisplay) {
                                if (row.lastAccess) {
                                     row.lastAccessDisplay = '<abbr data-toggle="tooltip" class="timeago" title="' + row.lastAccessAgo + '">' + row.lastAccessStr + '</abbr>';
                                 } else {
                                     row.lastAccessDisplay = 'Not yet logged in';
                                 }
                            }
                            
                            if (type === 'display') {
                                return row.lastAccessDisplay;
                            } else if (type === 'filter') {
                                return row.lastAccessStr;
                            } else if (type === 'sort') {
                                return row.lastAccess;
                            } else {
                                //Anything else and raw row
                                return row.lastAccess;
                            }
                        }
                    },
                    {
                        "targets": [7],
                        "width": "120px",
                        "data" : function(row, type, set) {
                            if (!row.statusDisplay) {
                                row.statusDisplay = '<div class="progress"><div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="' + row.status + '" aria-valuemin="0" aria-valuemax="100" style="width:' + row.status +'%;"></div</div>';
                            }
                            
                            if (type === 'display') {
                                return row.statusDisplay;
                            } else if (type === 'filter') {
                                return row.status;
                            } else if (type === 'sort') {
                                return row.status;
                            } else {
                                //Anything else and raw row
                                return row.status;
                            }
                        }
                    },
                    {
                        "targets": [8],
                        "orderable": false,
                        "width": "25px",
                        "data" : function(row, type, set) {
                            if (!row.iconDisplay) {
                                row.iconDisplay = '<span class="pe-7s-angle-down-circle pe-2x pull-right expand"></span>';
                            }
                            
                            if (type === 'display') {
                                return row.iconDisplay;
                            } else if (type === 'filter') {
                                return row.iconDisplay;
                            } else if (type === 'sort') {
                                return row.iconDisplay;
                            } else {
                                //Anything else and raw row
                                return row.iconDisplay;
                            }
                        }
                    }
                ],
                "sAjaxSource": "${helper.urlFor('ProjectJsonModule','projectRoster', [prj.projectId?c])}",
                "oLanguage": {
                    "sEmptyTable": "<span class='emptytable'>The roster is empty. Add a participant above to get started. </span>",
                    "sLoadingRecords": "<p>Loading roster...</p><img src='[@common.spinnerUrl /]' />"
                }
            });
        });
        
        $('#projectroster').on('click', 'a[data-trigger=roster-row-action]',function(ev){            
            var row = oTable.DataTable().row( $(this).parents('tr').first() ).data();
            var action = $(this).data('action');
            if (action==='link'){
                rowLinkAction(row);
            } else if (action==='impersonate') {
                rowImpersonateAction(row);                
            } else if (action==='move') {
                rowMoveAction(row);                
            } else {
                alert('Undefined row action: ' + action);
            }
            
            return false;
        });
        function rowLinkAction(row) {
            cocobox.infoDialog('Participation access link', row.participationLink);
            log(row);            
        };
        
        function rowImpersonateAction(row) {
            window.open(impersonateLink + '/' + row.id,'_blank');
        };
        
        function rowMoveAction(row) {
            moveParticipation(row.id);
        };
        

        cpweb.registerListform($("#projectrosterform").first());
        $('#listprojects_filter input').attr('placeholder', 'Search for projects');

        $.fn.clearForm = function() {
            return this.each(function() {
                var type = this.type, tag = this.tagName.toLowerCase();
                if (tag == "form")
                    return $(":input", this).clearForm();
                if (type == "text" || type == "email")
                    this.value = "";
            });
        };

        [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_ROSTER"]
        require(['jquery.form', 'dabox-common', 'dabox-formbeanjs'], function() {
            $("#uploadRoster").ajaxForm(cocobox.getAjaxFormbeanHandler("uploadRoster", undefined, {sectionClass: "alert alert-danger"}));
        });
        [/@]

        $("#cball").on('click', function(ev) {
            if (this.checked) {
                var items = $("input.rowcb").not(":checked");
                items.trigger('click');
                //Trigger change so that IE8- picks up the change
                items.trigger('change');
            } else {
                var items = $("input.rowcb").filter(":checked");
                items.trigger('click');
                //Trigger change so that IE8- picks up the change
                items.trigger('change');
            }
        })

    function runiCheck() {
      $('#projectroster input').icheck({
        checkboxClass: 'icheckbox_square-red',
        radioClass: 'iradio_square-red'
      });
    };


        $("#projectrosterform").submit(cpweb.projectRosterListForm);


    });



    var fetchAndInjectDetails = function(detailsData, injectInRow) {
        var ajaxCallUrl = detailsData.detailsUrl;

        cocobox.ajaxPost(ajaxCallUrl, {
            success: function(data) {
                $(injectInRow).empty();
                $(injectInRow).removeClass('loading');

                var expirationStr = detailsData.expirationStr;
                var expirationAgo = detailsData.expirationAgo;
                var expired = detailsData.expired;
                
                var completed = 0;
                for (var i = 0; i < data.progress.length; i++) {
                    if (data.progress[i].completed) {
                        completed++;
                    }
                    data.progress.completed = completed;
                }

                if (data.reports.length == 0) {
                    data.reports.push({empty: true});
                } else {

                    for (var i = 0; i < data.reports.length; i++) {
                        if (data.reports[i].type == 'application/pdf') {
                            data.reports[i].filetype = data.reports[i].type.split('application/').join('');
                        }

                    }
                }

                var renderedProgress = $('#progressTemplate').render(data.progress);
                var renderedReports = $('#reportinfoTemplate').render(data.reports);
                var renderedAdminlinks = $('#adminlinkTemplate').render(data.adminlinks);
                var renderedInvites = $('#invitesTemplate').render(data.idprojects);


                $(injectInRow).append($('#detailsTable').render({
                    renderedProgress: renderedProgress,
                    completedCids: completed,
                    totalnumberOfCidsWithProgress: data.progress.length,
                    renderedReports: renderedReports,
                    renderedAdminlinks: renderedAdminlinks,
                    renderedInvites: renderedInvites,
                    expired: expired,
                    expirationStr: expirationStr,
                    expirationAgo: expirationAgo
                }));
                
                jQuery.timeago.settings.allowFuture = true;
                $(injectInRow).find('.timeago').timeago();
                //Hide invite section if no invites
                if (renderedInvites.len < 1) {
                    $('.invites').hide();
                }
            }
        });
    };

    var showRow = function() {
        require(['dataTables-bootstrap', 'jsrender'], function() {
            var oTable = $('#projectroster').dataTable();
            var detailsData = {};

            $('.expand').click(function() {

                var parentTd = $(this).parent()[0];
                var clickedRow = $(parentTd).parent()[0];

                var aoData = oTable.fnGetData(clickedRow);
                
                log('this is the data for the clicked row', aoData);
                
                //attach the expirationDetails
                detailsData.expirationStr = aoData.expirationStr;
                detailsData.expirationAgo = aoData.expirationAgo;
                detailsData.expired = aoData.expired;
                
                detailsData.detailsUrl = aoData.detailsUrl;

                $(this).toggleClass('pe-7s-angle-down-circle');
                $(this).toggleClass('pe-7s-angle-up-circle');
                $(clickedRow).toggleClass('expanded');

                if (oTable.fnIsOpen(clickedRow)) {
                    oTable.fnClose(clickedRow);
                } else {
                    var injectInContainer = $('<div>');

                    oTable.fnOpen(clickedRow, injectInContainer, "details");
                    $(injectInContainer).attr('class', 'loading');

                    if (aoData.inError) {
                        $(injectInContainer).html('<p>Sorry, but something went wrong as we were setting up this participant. Try fixing this by either sending an email to ' + aoData.displayName + ' or by using the "Activate" functionality. If that does not do it, please reach out to tech support.');

                        if (aoData.bounced) {
                            $(injectInContainer).append('<p>The last email sent to ' + aoData.displayName + ' bounced back. Please check the email address and resend the email. </p>');
                        }

                    } else if (!aoData.activated) {
                        $(injectInContainer).html('<p>Invite the participant to see details here. </p>');

                    } else {
                        $(injectInContainer).attr('class', 'loading');
                        $(injectInContainer).html('<img src="${cocoboxCdn}/cocobox/img/loading.gif" alt="spinner"/>');
                        $(injectInContainer).attr('class', 'loading detailscontainer');
                        fetchAndInjectDetails(detailsData, injectInContainer);
                    }

                }

            });
        });
    };



    function showBounceInfo(strPartId) {
        cocobox.ajaxPost("${helper.urlFor('ProjectJsonModule','participationBounceInfo')}/" + strPartId, {
            success: showBounceDialog
        });
    }
    function showBounceDialog(data) {
        var bDialog = $("#bounceinfo").render(data);
        $(bDialog).dialog({
            width: 800,
            height: 600,
            modal: true,
            resizable: true
        });
    }

    function addMemberListener() {
        require(['dabox-common', 'dabox-jquery'], function() {
            cocobox.longOp();
            $(".save").cocobox('inputBlock');
        });
        return true;
    }

    $('#memberemail').keyup(function() {
        log($('#memberemail').val());
    });


    var impersonateBaseUrl = "${helper.urlFor('ProjectModule','impersonate')}";
    
    function impersonate(participationId) {
        window.location.href = impersonateBaseUrl+'/'+participationId;
        return false;
    }

    function moveParticipation(pid) {

        var moveSrc = moveLink + '/' +pid;

        require(["[@modal.javascript /]"], function(modal) {
            modal.open({
	               title: "Move",
	               src: moveSrc,
	               height: "400px",
                       width: "900px",
                       cancel: function() 
                        {/* Do nothing, otherwise redirect in popup */},
                       cancelUrl: window.location.href
            });
        });
    };

</script>
[/#assign]

[#assign cpweb_head]
${cpweb_head}
[/#assign]

[@dws.skin skin="CPAuth3" head=cpweb_head ctxMenu=cpweb_ctxMenu foot=foot orgName=orgName]

<article id="ccb-page-projectRoster">

[#include "../allocationFailure.html" /]

[@pInfo.projectInfo selected="participants"][/@pInfo.projectInfo]


[@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_ROSTER"]
<div role="tabpanel">

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#manual" aria-controls="manual" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-pencil"></span> Manual</a></li>
    <li role="presentation"><a href="#uploadroster" aria-controls="uploadroster" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-cloud-upload" aria-hidden="true"></span> Upload</a></li>
    [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_SELFREG"]
    <li role="presentation"><a href="#selfreg" aria-controls="selfreg" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> Self-Registration <span class="badge" id='selfreg-badge'>${prj.selfRegistrationEnabled?string('On','Off')}</span></a></li>
    [/@]
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane fade in active" id="manual">
        <div class="row">
            [#global formPrefix="cpweb" /]
            <form action="${helper.urlFor('ProjectModificationModule','addMember',[prj.projectId?c])}" name="addMemberForm" id="addMemberForm" method="post" onsubmit="return addMemberListener()">
                <div class="col-md-6">
                    [@bsform.inputText name="memberfirstname" tabindex="2" maxlength="64" /]
                </div>
                <div class="col-md-6">
                    [@bsform.inputText name="memberlastname" tabindex="3" maxlength="64" /]
                </div>
                <div class="col-xs-12">
                    [@bsform.inputEmail name="memberemail" tabindex="4" maxlength="96" /]
                    <button type="submit" tabindex="100" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-plus-sign"></span> [@dws.txt key='form.action.addmember' /]</button>
                </div>
            </form>
        </div>
    </div>
    <div role="tabpanel" class="tab-pane fade" id="uploadroster">
      [#include "rosterUpload.html" /]
    </div>
    [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_SELFREG"]
    <div role="tabpanel" class="tab-pane fade" id="selfreg">
            [@pRegistration.html /]
    </div>
    [/@]
  </div>

</div>

[/@]

<form method="post" id="projectrosterform" action="${helper.urlFor('ProjectModificationModule','listCommand')}">
    [@bsform.listformFields /]
    <input type="hidden" name="projectId" value="${prj.projectId?c}" />
    <input id="expirationdate" type="hidden" name="expirationdate" value="" />
    <input id="adjusteddate" type="hidden" name="expirationadjustment" value="" />
    
    <section class="ccb-table-list-actions">
        [@projectSecurity.permissionBlock permission="CP_SEND_MAIL_PROJECT"]
        <button class="btn btn-primary btn-sm" onclick="cpweb.runListCommand(this, $('#projectrosterform'), 'send');        
                return false" ${prj.invitePossible?string('','disabled="disabled"')}><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Send Email...</button>
        [/@]
        [@portalSecurity.permissionBlock permission="PRJ_CHANGE_EXPIRATION"]
        <button class="btn btn-primary-outlined btn-sm" onclick="cpweb.setExpiration(this, $('#projectrosterform'), 'setExpiration'); return false"><span class="glyphicon glyphicon-dashboard"></span> Set Expiration</button>
        [/@]
        [@portalSecurity.permissionBlock permission="PRJ_CHANGE_EXPIRATION"]
        <button class="btn btn-primary-outlined btn-sm" onclick="cpweb.adjustExpiration(this, $('#projectrosterform'), 'adjustExpiration');        
                return false"><span class="glyphicon glyphicon-time"></span> Adjust Expiration</button>
        [/@]
        [@projectSecurity.permissionBlock permission="PRJ_ACTIVATE_PARTICIPANT"]
            <button class="btn btn-primary-outlined btn-sm" onclick="cpweb.runListCommand(this, $('#projectrosterform'), 'activate');
                    return false" ${prj.invitePossible?string('','disabled="disabled"')} ><span class="glyphicon glyphicon-flash"></span> Activate</button>
        [/@]
        [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_ROSTER"]
        <button class="btn btn-primary-outlined btn-sm" onclick="return cpweb.rosterDelete(this, $('#projectrosterform'), 'delete', '${ctext("cpweb.project.roster.delete.title")?js_string}', '${ctext("cpweb.project.roster.delete.text")?js_string}');"><span class="glyphicon glyphicon-trash"></span> Delete</button>
        [/@]
        
        
        [#include "projectRosterCalendarActivatedSection.html" /]
    </section>

    <table class="table table-striped table-hover ccb-table" id="projectroster">
        <thead>
            <tr>
                <th><input type="checkbox" id="cball"></th>
                <th></th>
                <th></th>
                <th>Name</th>
                <th>Invited</th>
                <th>Last Email</th>
                <th>Last Seen</th>
                <th>Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <a href="${helper.urlFor('project.ProjectJsonModule','projectRosterExcel',[prj.projectId?c,'roster-'+prj.projectId?c+'.xls'])}">Download roster as a Excel file</a>
</form>
[#include "bounceInfo.html" /]

[#include "projectRosterParticipationErrorBox.html"]

</article>

[/@dws.skin]

