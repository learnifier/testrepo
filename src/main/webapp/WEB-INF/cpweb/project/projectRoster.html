[#ftl strip_text="true" /]

[#import "bounceInfo.html" as bInfoRender /]
[#import "projectInfo.html" as pInfo /]
[#import "projectRegistration.html" as pRegistration /]

[#assign foot]

[@bInfoRender.bRenderer][/@bInfoRender.bRenderer]

${cpweb_foot}

[#include "jsr_progressinfoTemplate.inc"]
[#include "jsr_adminlinkTemplate.inc"]
[#include "jsr_reportinfoTemplate.inc"]
[#include "jsr_detailsTable.inc"]
[#include "jsr_invitesTemplate.inc"]
[#include "jsr_expirationDialog.inc" /]
[#include "projectRosterMoveDialog.html" /]

[@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_SELFREG"]
  [@pRegistration.foot /]
[/@]

<script>
    $('#menu-projects').addClass('active');
    
</script>


<script id="roster-cell-action-template" type="text/x-handlebars-template">
<div class='btn-group'>
    <button type='button' class='btn btn-primary-outlined btn-sm dropdown-toggle' data-toggle='dropdown' aria-expanded='false'>Actions <span class='glyphicon glyphicon-menu-down'></span></button>
    <ul class='dropdown-menu dropdown-menu-right' role='menu'>
        {{#if activated}}
        <li><a href='#' data-trigger='roster-row-action' data-action='link'><span class="glyphicon glyphicon-link"></span>  Get Link</a></li>
        {{/if}}
        {{#if impersonateAllowed}}
        <li><a href='#' data-trigger='roster-row-action' data-action='impersonate'><span class="glyphicon glyphicon-eye-open"></span>  View As</a></li>
        {{/if}}
        {{#if moveAllowed}}
        <li><a href='#' data-trigger='roster-row-action' data-action='move'><span class="glyphicon glyphicon-log-out"></span>  Move</a></li>
        {{/if}}
        [#if security.userAccount.superUser]
        <li><a href='#' data-trigger='roster-row-action' data-action='raps'><span class="glyphicon glyphicon-list-alt"></span>  Technical info</a></li>
        [/#if]
    </ul>
</div>   
</script>


<script>
    var impersonateLink = "";
    var impersonateEnabled = false;
    [@projectSecurity.permissionBlock permission="PRJ_IMPERSONATE_PARTICIPANT"]
        impersonateLink = "${helper.urlFor('ProjectModule','impersonate')}";
        impersonateEnabled = true;
    [/@]

    var moveLink = "";
    var moveEnabled = ${moveEnabled?c};
    [@portalSecurity.permissionBlock permission="CP_MOVE_PARTICIPANT"]
        moveLink = "${helper.urlFor('project.move.ParticipantMoveModule','selectTarget',[prj.projectId])}";
    [/@]


    $(document).ready(function() {
        require(['cocobox-handlebars', 'dataTables-bootstrap', 'jquery.timeago', 'cocobox-icheck', '${contextPath}/js/project/projectCommon.js?${cycle.application.formattedStartTime.base36String}'], function(hb) {

            var source = $("#roster-cell-action-template").html();
            var rosterCellActionTemplate = hb.compile(source);
            var cbCounter = 0;
            window.oTable = $('#projectroster').dataTable({
                "dom": '<"row"<"col-sm-12"rt>><"row"<"col-sm-6"i><"col-sm-6"p>><"row"<"col-sm-12"l>>',
                "lengthMenu": [ [20, 50, 100, 1000, -1], [20, 50, 100, 1000, "All"] ],
                "pageLength": 100,
                "order": [[2, 'asc']],
                "createdRow": function(nRow, oObj, iDisplayIndex, iDisplayIndexFull) {
                    if (oObj.inError) {
                        $(nRow).addClass('error');
                        $(nRow).find('td').css('background', 'rgba(255,0,0,0.1)');
                        return nRow;
                    } else if (!oObj.activated) {
                        $(nRow).addClass('inactive');
                        $(nRow).css('opacity', '0.6');
                        return nRow;
                    }
                    else if (oObj.expired) {
                        $(nRow).attr('title', 'This participation has expired');
                        $(nRow).addClass('expired');
                        return nRow;
                    }
                },
                "initComplete": function() {
                    log('DataTables has finished its initialisation.');
                    toggleAllCheck();
                },
                "columnDefs": [
                    {
                        "targets": [0],
                        "data": function(row, type, val, meta) {
                            var hiddenString = $("input[name=__ids]").val(); // TODO: Handle multiple datatables
                            var allValues = hiddenString == "" ? [] : hiddenString.split(',');

                            if(type === 'set') {
                                if (val === true) {
                                    if (jQuery.inArray(String(row.id), allValues) == -1) {
                                        allValues.push(row.id);
                                    }
                                } else {
                                    //Remove state
                                    var index = jQuery.inArray(String(row.id), allValues);
                                    if (index != -1) {
                                        allValues.splice(index,1);
                                    }
                                }
                                hiddenString = allValues.join(',');
                                $("input[name=__ids]").val(hiddenString);
                                return;
                            }
                            return  (jQuery.inArray(String(row.id), allValues) !== -1);
                        },
                        "orderable": false,
                        "width": "24px",
                        "render": function(data, type, row, meta) {
                            var ids = $("input[name=__ids]").val().split(","),
                                    checked = (jQuery.inArray(String(row.id), ids) !== -1),
                                    cbId = "memberCb" + cbCounter,
                                    html = '<div><input id="' + cbId + '" type="checkbox" class="rowcb" data-rowid="' + row.id + '"'+ (checked?" checked":"") + ' /></div>';
                            var $toProcess = $(html);
                            $toProcess.icheck({
                                checkboxClass: 'icheckbox_square-red',
                                radioClass: 'iradio_square-red'
                            });
                            return $toProcess.html();
                        }
                    },

                    {
                        "targets": [1],
                        "orderable": false,
                        "width": "25px",
                        "data" : function(row, type, set) {
                            if (!row.iconDisplay) {
                                if (row.inError) {
                                    var msg = row.errorMsg;
                                    if (msg == null) {
                                        msg = 'Participation error reason is not known';
                                    }

                                    window.partError = window.partError || {};
                                    window.partError[row.id] = msg;
                                    var onclick = "onclick='showRosterPartErrorBox(window.partError[" + row.id + "])'";
                                    var data = '<a" ' + onclick + ' class="btn btn-link participationTriangle" alt="Participation Link"><span class="glyphicon glyphicon-alert text-danger"></span></a>';

                                    row.iconDisplay = data;
                                } else Â {
                                    row.iconDisplay = '<span class="pe-7s-plus pe-2x pull-right primaryColor expand"></span>';
                                }
                            }

                            if (type === 'display') {
                                return row.iconDisplay;
                            } else if (type === 'filter') {
                                return row.iconDisplay;
                            } else if (type === 'sort') {
                                return row.iconDisplay;
                            } else {
                                //Anything else and raw row
                                return row.iconDisplay;
                            }
                        },
                        "createdCell": function (td, cellData, rowData, row, col) {
                            showRow(td);
                        }
                    },
                    {
                        "targets": [2],
                        "width": "17%",
                        "data" : function(row, type, set) {
                            if (!row.displayNameDisplay) {
                                var data = '<a class="name" href="' + row.link + '" title="' + row.email + '">' + row.displayName + '</a> ';
                                row.displayNameDisplay = data;
                            }

                            if (type === 'display') {
                                return row.displayNameDisplay;
                            } else if (type === 'filter') {
                                return row.displayName;
                            } else if (type === 'sort') {
                                return row.displayName;
                            } else {
                                //Anything else and raw row
                                return row.displayName;
                            }
                        }
                    },
                    {
                        "targets": [3],
                        "width": "15%",
                        "data" : function(row, type, set) {
                            if (!row.firstEmailDisplay) {
                                if (row.firstEmailStr) {
                                    row.firstEmailDisplay =  row.firstEmailStr;
                                } else if (row.sending && !row.firstEmailStr) {
                                    row.firstEmailDisplay =  "Sending...";
                                } else {
                                    return null;
                                }
                            }

                            if (type === 'display') {
                                return row.firstEmailDisplay;
                            } else if (type === 'filter') {
                                return row.firstEmailStr;
                            } else if (type === 'sort') {
                                return row.firstEmail;
                            } else {
                                //Anything else and raw row
                                return row.firstEmail;
                            }
                        }
                    },
                    {
                        "targets": [4],
                        "width": "15%",
                        "data" : function(row, type, set) {
                            if (!row.lastEmailDisplay) {
                                if (row.sending) {
                                    row.lastEmailDisplay = "Sending..."
                                } else if (row.bounced) {
                                    row.lastEmailDisplay = '<a href="#" onclick="showBounceInfo(' + row.id + '); return false" class="text-danger" title="' + row.lastEmailStr + '"><strong>Bounced back</strong></a>';
                                } else {
                                    row.lastEmailDisplay = row.lastEmailStr;
                                }
                            }

                            if (type === 'display') {
                                return row.lastEmailDisplay;
                            } else if (type === 'filter') {
                                return row.lastEmailStr;
                            } else if (type === 'sort') {
                                return row.lastEmail;
                            } else {
                                //Anything else and raw row
                                return row.lastEmail;
                            }
                        }
                    },
                    {
                        "targets": [5],
                        "data" : function(row, type, set) {
                            if (!row.lastAccessDisplay) {
                                if (row.lastAccess) {
                                    row.lastAccessDisplay = '<abbr data-toggle="tooltip" class="timeago" title="' + row.lastAccessAgo + '">' + row.lastAccessStr + '</abbr>';
                                } else {
                                    row.lastAccessDisplay = 'Not yet logged in';
                                }
                            }

                            if (type === 'display') {
                                return row.lastAccessDisplay;
                            } else if (type === 'filter') {
                                return row.lastAccessStr;
                            } else if (type === 'sort') {
                                return row.lastAccess;
                            } else {
                                //Anything else and raw row
                                return row.lastAccess;
                            }
                        },
                        "createdCell": function (td, cellData, rowData, row, col) {
                            $('.timeago', td).timeago();
                            $('[data-toggle="tooltip"]', td).tooltip()
                        }
                    },
                    {
                        "targets": [6],
                        "width": "120px",
                        "data" : function(row, type, set) {
                            if (!row.statusDisplay) {
                                row.statusDisplay = '<div class="progress"><div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="' + row.status + '" aria-valuemin="0" aria-valuemax="100" style="width:' + row.status +'%;">' + row.status +'%</div</div>';
                            }

                            if (type === 'display') {
                                return row.statusDisplay;
                            } else if (type === 'filter') {
                                return row.status;
                            } else if (type === 'sort') {
                                return row.status;
                            } else {
                                //Anything else and raw row
                                return row.status;
                            }
                        }
                    },
                    {
                        "targets": [7],
                        "orderable": false,
                        "width": "80px",
                        "data" : function(row, type, set) {
                            if(!row.actionsDisplay) {
                                row.impersonateAllowed = impersonateEnabled && row.activated;
                                row.moveAllowed = moveEnabled && !row.inError;
                                var html = rosterCellActionTemplate(row);
                                row.actionsDisplay = html;
                            }

                            if (type === 'display') {
                                return row.actionsDisplay;
                            } else if (type === 'filter') {
                                return null;
                            } else if (type === 'sort') {
                                return null;
                            } else {
                                //Anything else and raw row
                                return row.actionsDisplay;
                            }
                        }
                    }
                ],
                "sAjaxSource": "${helper.urlFor('ProjectJsonModule','projectRoster', [prj.projectId?c])}",
                "oLanguage": {
                    "sEmptyTable": "<span class='emptytable'>The roster is empty. Add a participant above to get started. </span>",
                    "sLoadingRecords": "<p>Loading roster...</p><img src='[@common.spinnerUrl /]' />"
                }
            });
        });

        $(document).on('change', 'input.rowcb[type=checkbox]', function(){
            return cpweb.rowcbChange(this);
        });

        $('#projectroster').on('click', 'a[data-trigger=roster-row-action]',function(ev){
            var row = oTable.DataTable().row( $(this).parents('tr').first() ).data();
            var action = $(this).data('action');
            if (action==='link'){
                rowLinkAction(row);
            } else if (action==='impersonate') {
                rowImpersonateAction(row);
            } else if (action==='move') {
                rowMoveAction(row);
            }
            [#if security.userAccount.superUser]
            else if (action==="raps") {
                window.location = "${helper.urlFor('project.ProjectModule','raps',[prj.projectId])}/"+row.id;
            }
            [/#if]
            else {
                alert('Undefined row action: ' + action);
            }

            return false;
        });
        function rowLinkAction(row) {
            cocobox.infoDialog('Participation access link', row.participationLink);
            log(row);
        };

        function rowImpersonateAction(row)Â {
            window.open(impersonateLink + '/' + row.id,'_blank');
        };

        function rowMoveAction(row)Â {
            moveParticipation(row.id);
        };


        cpweb.registerListform($("#projectrosterform").first());
        $('#listprojects_filter input').attr('placeholder', 'Search for projects');

        $.fn.clearForm = function() {
            return this.each(function() {
                var type = this.type, tag = this.tagName.toLowerCase();
                if (tag == "form")
                    return $(":input", this).clearForm();
                if (type == "text" || type == "email")
                    this.value = "";
            });
        };

        [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_ROSTER"]
        require(['jquery.form', 'dabox-common', 'dabox-formbeanjs'], function() {

            var handler = cocobox.getAjaxFormbeanHandler("uploadRoster", undefined, {sectionClass: "alert alert-danger"});

            var oldBefore = handler.beforeSend;

            var oldSuccess = handler.success;

            var longOp;

            handler.beforeSend = function() {
                longOp = cocobox.longOp();

                if(oldBefore) {
                    oldBefore();
                }
            }

            handler.success = function() {
                longOp.abort();

                oldSuccess.apply(this, arguments);
            }

            $("#uploadRoster").ajaxForm(handler);
        });
        [/@]

        $("#cball").on('click', function(ev) {
            var checked = this.checked;
            $.each(oTable.api().rows().indexes(), function(i, ri){
                oTable.api().cell(ri, 0).data(checked);
            });
        });

        function runiCheck(cell) {
            $('input', cell).icheck({
                checkboxClass: 'icheckbox_square-red',
                radioClass: 'iradio_square-red'
            });
        };

        function toggleAllCheck() {

            $('#cball').icheck({
                checkboxClass: 'icheckbox_square-red',
                radioClass: 'iradio_square-red'
            });
        };

        $("#projectrosterform").submit(cpweb.projectRosterListForm);

        require(['select2.min'], function() {
            // Group tab
            $("#addByGroup").select2({
                placeholder: "Select a group",
                allowClear: true,
                formatSelection: function(opt){return opt.text.trim()}
                // formatResult is templateSelection in 4.0
            });
            $("#group button[type=submit]").on('click', function (ev) {
                var cugId = $("#group select").val()
                        , cugName = $("#group select option:selected").text()
                        , infoUrl = "${helper.urlFor('project.ProjectJsonModule','groupInfo', [prj.projectId?c])}/" + cugId;
                if(!cugId) {
                    return;
                }
                $.getJSON(infoUrl).done(function (data) {
                    if (data.members == 0) {
                        cocobox.infoDialog("Add members", "There are no members in this group.");
                    } else {
                        cocobox.confirmationDialogYesNo("Add members", "Add " + data.members + " members from the group " + cugName + " to the project?", function () {
                            var addUrl = "${helper.urlFor('project.ProjectJsonModule','addMembersByGroup', [prj.projectId?c])}/" + cugId;
                            cocobox.longOp();
                            $.getJSON(addUrl).done(function (data) {
                                window.location.reload();
                            }).fail(function (jqxhr, textStatus, error) {
                                cocbox.infoDialog("Error", "There was a problem adding members: " + textStatus);
                            });
                        });
                    }
                }).fail(function (jqxhr, textStatus, error) {
                    console.error("Could not look up group id " + cugId + ". " + textStatus + ", " + error);
                });
            });

            // "Mark by group"
            $("#markByGroup").select2({
                placeholder: "Select members in group",
                allowClear: true,
                formatSelection: function(opt){return opt.text.trim()}
                // formatResult is templateSelection in 4.0
            }).change(function(){
                var cugId = $("#markByGroup").val(),
                        url = "${helper.urlFor('project.ProjectJsonModule','listGroupMembers', [prj.projectId?c])}/" + cugId;
                $.getJSON(url).done(function (data) {
                    var h = {};
                    $.each(data.aaData, function(i, member){
                        h[member.userId] = true;
                    });
                    $.each(oTable.api().rows().indexes(), function(i, ri){
                        if(oTable.api().row(ri).data().userId in h) {
                            oTable.api().cell(ri, 0).data(true);
                        }
                    });
                }).fail(function (jqxhr, textStatus, error) {
                    cocbox.infoDialog("Error", "There was a problem getting members from group: " + textStatus);
                }).always(function(){
                    $("#markByGroup").select2("val", "");
                })
            });

        });

    }); // End document ready



    var fetchAndInjectDetails = function(detailsData, injectInRow) {
        require(['cocobox-handlebars', 'jquery.timeago', 'cocobox-icheck'], function (hb) {
            var ajaxCallUrl = detailsData.detailsUrl;

            cocobox.ajaxPost(ajaxCallUrl, {
                success: function(data) {
                    $(injectInRow).empty();
                    $(injectInRow).removeClass('loading');

                    var expirationStr = detailsData.expirationStr;
                    var expirationAgo = detailsData.expirationAgo;
                    var expired = detailsData.expired;

                    for (var i = 0; i < data.reports.length; i++) {
                        if (data.reports[i].type == 'application/pdf') {
                            data.reports[i].filetype = data.reports[i].type.split('application/').join('');
                        }
                    }

                    hb.registerHelper('StatusName', function (activityStatus) {


                        if (activityStatus == 'notAttempted') {
                            var result = '<span class="text-muted">Not started</span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'incomplete') {
                            var result = '<span class="text-info">In progress</span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'overdue') {
                            var result = '<span class="text-danger">Overdue</span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'locked') {
                            var result = '<span class="text-muted">Locked</span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'failed') {
                            var result = '<span class="text-danger">Failed</span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'completed') {
                            var result = '<span class="text-success">Completed</span>';
                            return new hb.SafeString(result);
                        } else {
                            return 'Unknown statusName:' + activityStatus;
                        }



                    });


                    hb.registerHelper('StatusImage', function (activityStatus) {

                        if (activityStatus == 'notAttempted') {
                            var result = '<span class="item__icon text-muted pe-7s-play pe-va pe-2x pe-fw"></span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'incomplete') {
                            var result = '<span class="item__icon text-info pe-7s-glasses pe-va pe-2x pe-fw"></span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'overdue') {
                            var result = '<span class="item__icon text-danger pe-7s-attention pe-va pe-2x pe-fw"></span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'locked') {
                            var result = '<span class="item__icon text-muted pe-7s-lock pe-va pe-2x pe-fw"></span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'failed') {
                            var result = '<span class="item__icon text-danger pe-7s-close-circle pe-va pe-2x pe-fw"></span>';
                            return new hb.SafeString(result);
                        } else if (activityStatus == 'completed') {
                            var result = '<span class="item__icon text-success pe-7s-check pe-va pe-2x pe-fw"></span>';
                            return new hb.SafeString(result);
                        } else {
                            return 'Unknown statusImage:' + activityStatus;
                        }

                    });

                    var templateSource = $("#roster-expand-template").html();
                    var template = hb.compile(templateSource);

                    var renderedProgress = template(data)
                    var renderedReports = $('#reportinfoTemplate').render(data.reports);
                    var renderedAdminlinks = $('#adminlinkTemplate').render(data.adminlinks);
                    var renderedInvites = $('#invitesTemplate').render(data.idprojects);

                    $(injectInRow).append($('#detailsTable').render({
                        renderedProgress: renderedProgress,
                        activitiesCompleted: data.activitiesTotal,
                        activityCount: data.activityCount,
                        renderedReports: renderedReports,
                        renderedAdminlinks: renderedAdminlinks,
                        renderedInvites: renderedInvites,
                        expired: expired,
                        expirationStr: expirationStr,
                        expirationAgo: expirationAgo,
                        reportsAvailable: data.reports.length !== 0
                    }));
                    //Show dropdown
                    $(".showDetails", injectInRow).click(function () {
                        $('.ToggleDrop').addClass("greyish");
                        $('.hide').addClass("tbRow");
                        $('[data-toggle="tooltip"]').tooltip()
                    });

                    //Hide dropdown
                    $(".showOverview", injectInRow).click(function () {
                        $('.ToggleDrop').removeClass("greyish");
                        $('.hide').removeClass("tbRow");
                    });

                    jQuery.timeago.settings.allowFuture = true;
                    $(injectInRow).find('.timeago').timeago();
                    //Hide invite section if no invites
                    if (renderedInvites.length < 1) {
                        $('.invites').hide();
                    }
                    $('[data-toggle="tooltip"]').tooltip();
                }
            });
        });
    };

    var showRow = function(cell) {
        require(['dataTables-bootstrap', 'jsrender'], function() {
            var oTable = $('#projectroster').dataTable();
            var detailsData = {};

            $('.expand', cell).click(function() {

                var parentTd = $(this).parent()[0];
                var clickedRow = $(parentTd).parent()[0];

                var aoData = oTable.fnGetData(clickedRow);

                log('this is the data for the clicked row', aoData);

                //attach the expirationDetails
                detailsData.expirationStr = aoData.expirationStr;
                detailsData.expirationAgo = aoData.expirationAgo;
                detailsData.expired = aoData.expired;

                detailsData.detailsUrl = aoData.detailsUrl;

                $(this).toggleClass('pe-7s-plus');
                $(this).toggleClass('pe-7s-less');
                $(clickedRow).toggleClass('expanded');

                if (oTable.fnIsOpen(clickedRow)) {
                    oTable.fnClose(clickedRow);
                } else {
                    var injectInContainer = $('<div>');

                    oTable.fnOpen(clickedRow, injectInContainer, "details");
                    $(injectInContainer).attr('class', 'loading');

                    if (aoData.inError) {
                        $(injectInContainer).html('<p>Sorry, but something went wrong as we were setting up this participant. Try fixing this by either sending an email to ' + aoData.displayName + ' or by using the "Activate" functionality. If that does not do it, please reach out to tech support.');

                        if (aoData.bounced) {
                            $(injectInContainer).append('<p>The last email sent to ' + aoData.displayName + ' bounced back. Please check the email address and resend the email. </p>');
                        }

                    } else if (!aoData.activated) {
                        $(injectInContainer).html('<p>Invite the participant to see details here. </p>');

                    } else {
                        $(injectInContainer).attr('class', 'loading');
                        $(injectInContainer).html('<img src="[@common.spinnerUrl /]" alt="spinner"/>');
                        $(injectInContainer).attr('class', 'loading detailscontainer');
                        fetchAndInjectDetails(detailsData, injectInContainer);
                    }

                }

            });
        });
    };



    function showBounceDialog(data) {
        require(['dabox-common'], function() {
            var bDialog = $("#bounceinfo").render(data);
            cocobox.infoDialog('Bounce back message',bDialog);
        });
    }



    function showBounceInfo(strPartId) {
        cocobox.ajaxPost("${helper.urlFor('ProjectJsonModule','participationBounceInfo')}/" + strPartId, {
            success: showBounceDialog
        });
    }





    function addMemberListener() {
        require(['dabox-common', 'dabox-jquery'], function() {
            cocobox.longOp();
            $(".save").cocobox('inputBlock');
        });
        return true;
    }

    $('#memberemail').keyup(function() {
        log($('#memberemail').val());
    });


    var impersonateBaseUrl = "${helper.urlFor('ProjectModule','impersonate')}";

    function impersonate(participationId) {
        window.location.href = impersonateBaseUrl+'/'+participationId;
        return false;
    }

    function moveParticipation(pid) {

        var moveSrc = moveLink + '/' +pid;

        require(["[@modal.javascript /]"], function(modal) {
            modal.open({
                title: "Move",
                src: moveSrc,
                height: "400px",
                width: "900px",
                cancel: function()
                {/* Do nothing, otherwise redirect in popup */},
                cancelUrl: window.location.href
            });
        });
    };

    function setExpiration(button, listform, cmd) {
        require(["${contextPath}/js/project/projectRoster.js?${cycle.application.formattedStartTime.base36String}"], function(pr) {
            pr.setExpiration(button, listform, cmd);
        });
    };

</script>
[/#assign]

[#assign cpweb_head]
${cpweb_head}

[/#assign]

[@dws.skin skin=skinName head=cpweb_head ctxMenu=cpweb_ctxMenu foot=foot orgName=orgName]

<article id="ccb-page-projectRoster">

[#include "../allocationFailure.html" /]

[@pInfo.projectInfo selected="participants"][/@pInfo.projectInfo]


[@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_ROSTER"]

[#macro genOptions group level prefix]
    <option value="${group.groupId?c}">${prefix}${group.name?xhtml}</option>
    [#list group.children as sg]
        [@genOptions group=sg level=level+1 prefix=prefix + "&nbsp;&nbsp;&nbsp;&nbsp;"][/@genOptions]
    [/#list]
[/#macro]
[#macro genGroupSelect groups selectId]
    <select id="${selectId}" style="margin-bottom: 10px; min-width:200px !important;">
        <option value=""></option>
        [#list groups as g]
        [@genOptions group=g level=0 prefix=""][/@genOptions]
        [/#list]
    </select>
[/#macro]

<div role="tabpanel" class="ccb-tabpanel ccb-tabpanel--colored">

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#manual" aria-controls="manual" role="tab" data-toggle="tab"><span class="pe-7s-add-user pe-va pe-lg"></span> Individual</a></li>
    <li role="presentation"><a href="#group" aria-controls="manual" role="tab" data-toggle="tab"><span class="pe-7s-users pe-va pe-lg"></span> Group</a></li>
    <li role="presentation"><a href="#uploadroster" aria-controls="uploadroster" role="tab" data-toggle="tab"><span class="pe-7s-cloud-upload pe-va pe-lg" aria-hidden="true"></span> Upload</a></li>
    [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_SELFREG"]
    <li role="presentation"><a href="#selfreg" aria-controls="selfreg" role="tab" data-toggle="tab"><span class="pe-7s-id pe-va pe-lg" aria-hidden="true"></span> Self-Registration <span class="badge" id='selfreg-badge'>${prj.selfRegistrationEnabled?string('On','Off')}</span></a></li>
    [/@]
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane fade in active" id="manual">
        <div class="row">
            [#global formPrefix="cpweb" /]
            <form action="${helper.urlFor('ProjectModificationModule','addMember',[prj.projectId?c])}" name="addMemberForm" id="addMemberForm" method="post" onsubmit="return addMemberListener()">
                <div class="col-md-6">
                    [@bsform.inputText name="memberfirstname" tabindex="2" maxlength="64" /]
                </div>
                <div class="col-md-6">
                    [@bsform.inputText name="memberlastname" tabindex="3" maxlength="64" /]
                </div>
                <div class="col-xs-12">
                    [@bsform.inputEmail name="memberemail" tabindex="4" maxlength="96" /]
                    <button type="submit" tabindex="100" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-plus-sign"></span> [@dws.txt key='form.action.addmember' /]</button>
                </div>
            </form>
        </div>
    </div>
    <div role="tabpanel" class="tab-pane fade" id="group">
        <div class="row">
            <div class="col-sm-6 col-lg-6">
                [@genGroupSelect groups=groups selectId="addByGroup"][/@genGroupSelect]
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <div class="form-group">
                    <button type="submit" tabindex="100" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-plus-sign"></span> [@dws.txt key='form.action.addmembersbygroup' /]</button>
                </div>
            </div>
        </div>
    </div>
    <div role="tabpanel" class="tab-pane fade" id="uploadroster">
      [#include "rosterUpload.html" /]
    </div>
    [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_SELFREG"]
    <div role="tabpanel" class="tab-pane fade" id="selfreg">
            [@pRegistration.html /]
    </div>
    [/@]
  </div>

</div>

[/@]

<form method="post" id="projectrosterform" action="${helper.urlFor('ProjectModificationModule','listCommand')}">
    [@bsform.listformFields /]
    <input type="hidden" name="projectId" value="${prj.projectId?c}" />
    <input id="expirationdate" type="hidden" name="expirationdate" value="" />
    <input id="adjusteddate" type="hidden" name="expirationadjustment" value="" />
    
    <section class="ccb-table-list-actions">
        [@projectSecurity.permissionBlock permission="CP_SEND_MAIL_PROJECT"]
        <button class="btn btn-primary btn-sm" onclick="cpweb.runListCommand(this, $('#projectrosterform'), 'send');        
                return false" ${prj.invitePossible?string('','disabled="disabled"')}><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Send Email...</button>
        [/@]
        [@portalSecurity.permissionBlock permission="PRJ_CHANGE_EXPIRATION"]
        <button class="btn btn-primary-outlined btn-sm" onclick="setExpiration(this, $('#projectrosterform'), 'setExpiration'); return false"><span class="glyphicon glyphicon-dashboard"></span> Change Expiration</button>
        [/@]        
        [@projectSecurity.permissionBlock permission="PRJ_ACTIVATE_PARTICIPANT"]
            <button class="btn btn-primary-outlined btn-sm" onclick="cpweb.runListCommand(this, $('#projectrosterform'), 'activate');
                    return false" ${prj.invitePossible?string('','disabled="disabled"')} ><span class="glyphicon glyphicon-flash"></span> Activate</button>
        [/@]
        [@projectSecurity.permissionBlock permission="CP_EDIT_PROJECT_ROSTER"]
        <button class="btn btn-primary-outlined btn-sm" onclick="return cpweb.rosterDelete(this, $('#projectrosterform'), 'delete', '${ctext("cpweb.project.roster.delete.title")?js_string}', '${ctext("cpweb.project.roster.delete.text")?js_string}');"><span class="glyphicon glyphicon-trash"></span> Delete</button>
        [/@]
        [@genGroupSelect groups=groups selectId="markByGroup"][/@genGroupSelect]

        
        [#include "projectRosterCalendarActivatedSection.html" /]
    </section>

    <div class="table-responsive">
        <table class="table table-striped table-hover ccb-table" width="100%" id="projectroster">
            <thead>
                <tr>
                    <th><input type="checkbox" id="cball"></th>
                    <th></th>
                    <th>Name</th>
                    <th>Invited</th>
                    <th>Last Email</th>
                    <th>Last Seen</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <a href="${helper.urlFor('project.ProjectJsonModule','projectRosterExcel',[prj.projectId?c,'roster-'+prj.projectId?c+'.xls'])}" class="pull-right">Download roster as a Excel file</a>
    </div>
</form>
[#include "bounceInfo.html" /]

[#include "projectRosterParticipationErrorBox.html"]

</article>

[/@dws.skin]

