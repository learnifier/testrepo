[#ftl strip_text="true" /]

[#import "projectInfo.html" as pInfo /]

[#assign cpweb_head ]
${cpweb_head}

<link rel='stylesheet' type='text/css' href='${cocoboxCdn}/cocobox/css/select2/select2.css'/>
<link rel='stylesheet' type='text/css' href='${cocoboxCdn}/cocobox/css/select2/select2-bootstrap.css'/>
[/#assign]


[#assign cpweb_foot ]
${cpweb_foot}
<script>
    $('#tm_projects').addClass('activeItem').prev().addClass('prevItem');
    
    require(['select2.min'], function()Â {
        
       $("#userSelect").select2({
            placeholder: "Search for a user",
            minimumInputLength: 2,
            ajax: { 
                url: "${helper.urlFor('project.role.ProjectRoleJsonModule', 'searchUser', [org.id])}",
                dataType: 'json',
                data: function (term, page) {
                    return {
                        term: term, // search term
                        page_limit: 10
                    };
                },
                results: function (data, page) { 
                    return {results: data.results};
                }
            },
            formatResult: function(data) {
                return '<span>' + data.text + '</span><br/><span>' + data.email + ' </span>' ;
            },
            formatSelection: function(data) {
                
                $('#userSelect').attr('value', data.id);
                
                return '<p value="' + data.id + '"> selected user: ' + data.text + '</p>';
            }
        }); 
    });
    
    
    function assign() {
        var id = $('#userSelect').val();
        log(id);
        
        var role = $('#userRole').val();
        log(role);
        
        $.ajax({
            url: "${helper.urlFor('project.ProjectModificationModule','assignRole',[prj.projectId])}",
            method: "POST",
            data: {
                userId: id,
                role: role
            },
            success: function(data) {
                log(data);
            }
        });
        
    }
    
    require(['dataTables194/jquery.dataTables.min', 'dabox-common'], function() {
       
        var oTable = $('#userroleslist').dataTable({
            "sDom": 'rt<"dataTables_footer clearfix"i>',
            "bPaginate": false,            
            "aaSorting": [[0,'asc']],
            "aoColumnDefs": [
                {
                    "aTargets": [ 0 ],
                    "mData": "displayName",
                    "fnRender": function ( oObj ) {
                        return  '<span title="' +oObj.aData.displayName + '">' + cocobox.trunc(oObj.aData.displayName, 20) + '</span>';
                    }
                },
                {
                    "aTargets": [ 1 ],
                    "mData": null,
                    "sWidth": "10%",
                    "bSortable": false,
                    "fnRender": function ( oObj ) {
                        [#if security.hasPermission("BO_EDIT_USER")]
                        
                            for(var i = 0; i < oObj.aData.roles.length; i++) {
                                return '<button onclick="deleteMember(\'' +  oObj.aData.roles[i].role + '\',\'' + oObj.aData.roles[i].deleteRoleLink + '\',\'' + oObj.aData.userId + '\')">' + oObj.aData.roles[i].roleName + ' </button>';
                            }
                            
                            
                        [#else]
                          return '';
                        [/#if]
                    }
                }


            ],
                        
            "sAjaxSource": "${helper.urlFor('project.ProjectJsonModule','listProjectRoleUsers',[prj.projectId])}",
             
            "oLanguage": {
                "sEmptyTable": "<span class='emptytable'>This project has no users with roles assigned </span>",
                "sLoadingRecords": "<p>Loading roles...</p><img src='${contextPath}/img/spinner-threedots.gif' />"
            }
        });
       

        
    });
    
    
    function deleteMember(role, deleteLink, userId) {
        $.ajax({
            url: deleteLink,
            method: "POST",
            data: {
                role: role,
                userId: userId
            }, 
            success: function(data) {
                log(data);
            }
        })
    }
    
    
</script>
[/#assign]

[@dws.skin skin="CPAuth2" head=cpweb_head ctxMenu=cpweb_ctxMenu foot=cpweb_foot orgName=orgName]

[@pInfo.projectInfo selected="projectadmin"][/@pInfo.projectInfo]

<h2>[@dws.txt key="cpweb.project.roles.title" /]</h2>

<form method="POST" action="${helper.urlFor('project.ProjectModificationModule','assignRole',[prj.projectId])}">
    <input name="userId" type="number" id="userSelect" class="bigdrop">

    
    [#list projectRoles?keys as pr]
    <label>${projectRoles[pr]}
    <input type="radio" name="role" value="${pr}">
    </label>
    [/#list]
    
    <button type="submit">Assign</button>    
</form>

<section class="list">
    <table class="list" id="userroleslist">
        <thead>
            <tr>
                <th>Role</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</section>
    


[/@dws.skin]

