[#ftl strip_text="true" /]

[#import "projectInfo.html" as pInfo /]

[#assign cpweb_head ]
${cpweb_head}

<link rel='stylesheet' type='text/css' href='${cocoboxCdn}/cocobox/css/select2/select2.css'/>
<link rel='stylesheet' type='text/css' href='${cocoboxCdn}/cocobox/css/select2/select2-bootstrap.css'/>
[/#assign]


[#assign cpweb_foot ]
${cpweb_foot}
<script>
    $('#menu-projects').addClass('active');
    
    require(['select2.min'], function()Â {
        
       $("#userSelect").select2({
            multiple: true,
            ajax: { 
                url: "${helper.urlFor('project.role.ProjectRoleJsonModule', 'searchUser', [org.id])}",
                minimumInputLength: -1,
                dataType: 'json',
                quietMillis: 300,
                data: function (term, page) {
                    return {
                        term: term,
                        page_limit: 10
                    };
                },
                results: function (data, page) { 
                    //log('result' , data);
                    return {results: data.results};
                }
            },
            formatResult: function(data) {
                return '<span>' + data.text + '</span><br/><span>' + data.email + ' </span>' ;
            },
            formatSelection: function(data) {
                
                //log('formatSelection' , data);
                
                $('#userSelect').attr('value', data.email);
                
                return '<p value="' + data.email + '">' + data.text + '</p>';
            },
            createSearchChoice: function(term, data) { 
                if ($(data).filter(function() { 
                    return this.text.localeCompare(term)===0; 
                }).length===0) {
                    
                     $('#userSelect').attr('value', data.email);
                    
                    return {id:term, text: term, email: 'Add email to assign new team member'};
                } 
            }
        }); 
    }); 
    
    require(['dataTables194/jquery.dataTables.min', 'dabox-common'], function() {
       
        var oTable = $('#userroleslist').dataTable({
            "sDom": 'rt<"dataTables_footer clearfix"i>',
            "bPaginate": false,            
            "aaSorting": [[0,'asc']],
            "aoColumnDefs": [
                {
                    "aTargets": [ 0 ],
                    "mData": "displayName",
                    "fnRender": function ( oObj ) {
                        var dName = oObj.aData.displayName;
                        if (dName.length < 2) {
                            return oObj.aData.email;
                        }
                        return  '<span title="' +dName + '">' + cocobox.trunc(dName, 20) + '</span>';
                    }
                },
                {
                    "aTargets": [ 1 ],
                    "mData": null,
                    "sWidth": "30%",
                    "bSortable": false,
                    "fnRender": function ( oObj ) {
                            var roleList='';
                            for(var i = 0; i < oObj.aData.roles.length; i++) {
                                roleList+= '<p style="margin: 3px 0; line-height: 14px;">' + oObj.aData.roles[i].roleName + ' - <a style="cursor: pointer;" onclick="deleteMember(\'' +  oObj.aData.roles[i].role + '\',\'' + oObj.aData.roles[i].deleteRoleLink + '\',\'' + oObj.aData.userId + '\')">Remove role</a></p>';
                            }
                            return roleList;                            
                        [#if security.hasPermission("BO_EDIT_USER")]
                        [#else]
                          return '';
                        [/#if]
                    }
                }


            ],
                        
            "sAjaxSource": "${helper.urlFor('project.ProjectJsonModule','listProjectRoleUsers',[prj.projectId])}",
             
            "oLanguage": {
                "sEmptyTable": "<span class='emptytable'>There are no users on this team</span>",
                "sLoadingRecords": "<p>Loading team members...</p><img src='[@common.spinnerUrl /]' />"
            }
        });
       

        
    });
    
    
    function deleteMember(role, deleteLink, userId) {
        $("#delUserId").val(userId);
        $("#delRole").val(role);
        var form = $("#deleteRoleForm");
        form.attr("action", deleteLink);
        form.submit();
    };
    
    
</script>
[/#assign]

[@dws.skin skin="CPAuth3" head=cpweb_head ctxMenu=cpweb_ctxMenu foot=cpweb_foot orgName=orgName]

[@pInfo.projectInfo selected="projectadmin"][/@pInfo.projectInfo]

<h2>[@dws.txt key="cpweb.project.roles.title" /]</h2>

<form method="POST" action="${helper.urlFor('project.ProjectModificationModule','assignRoleEmail',[prj.projectId])}" >
    <section id="addtoteam">
        <section class="field">
        <div class="inputtext">
        <label for="userSelect">Select a user or add with a new email</label>
        <input name="email" type="email" id="userSelect" class="bigdrop">
        </div>
        <div class="inputtext">
            <label for="roleSelect">Select role</label>
            <select id="roleSelect" name="role">    
            [#list projectRoles?keys as pr]
            <option value="${pr}">${projectRoles[pr]}</option>
            [/#list]
            </select>
        </div>
        </section>
        <section class="action">
            <button type="submit" class="btn btn-primary">Assign</button>    
        </section>
    </section>
</form>

<section class="list">
    <table class="list" id="userroleslist">
        <thead>
            <tr>
                <th>Name</th>
                <th>Role</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</section>
    
<div style="display: none">
    <form id="deleteRoleForm" method="POST" action="">
            <input type="hidden" id="delUserId" name="userId" />
            <input type="hidden" id="delRole" name="role" />
    </form>
</div>

[/@dws.skin]

