[#ftl strip_text="true" /]

[#macro fieldValue name]${oldValues[name]!databankValues[name]!''}[/#macro]


[#assign foot]
${cpweb_foot}
<script type="text/javascript">
    $('#tm_projects').addClass('activeItem').prev().addClass('prevItem');    

    dpSettings = {
        'defaultDate': "+1d",
        'minDate': 0,
        'showAnim': 'slideDown',
        'dateFormat': 'yy-mm-dd',
		'timeFormat': 'HH:mm',
        'showOn': "both",
        'buttonImage': "${cocoboxCdn}/cocobox/img/calendar-icon2.png",
        'buttonImageOnly': true
    };
</script>
[/#assign]


[#assign cpweb_head]



<script>


    require(['async!//maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places'] , function() {
    
        $(document).ready(function() {
            function initialize(elementId) {

                var input = document.getElementById(elementId);

                var autocomplete = new google.maps.places.Autocomplete(input);

                google.maps.event.addListener(autocomplete, 'place_changed', function() {
                    var place = autocomplete.getPlace();
                    if (!place.geometry) {
                        return;
                    }
                    
                    var mapsUrl = createMapsUrl(place);
                    
                    log(elementId);
                    log(mapsUrl);
                    log($(elementId).closest('.details').find('.locUrl input'));
                    
                    $('#'+elementId).closest('.details').find('.locUrl input').val(mapsUrl);
                    
                    
                });

            }


            function createMapsUrl(place) {
                
                var street,number,town = '';
                
                if (place.address_components) {
                    street = (place.address_components[1] && place.address_components[1].short_name || '');
                    number = (place.address_components[0] && place.address_components[0].short_name || '');
                    town = (place.address_components[2] && place.address_components[2].short_name || '');
                }

                var long,lat; 
                if(place.geometry.location) {
                    lat = (place.geometry.location.A).toString().substring(0,9);
                    long = (place.geometry.location.k).toString().substring(0,9);
                }

                var mapsBaseUrl = 'http://www.google.com/maps/place/',
                    mapsUrl = mapsBaseUrl+encodeURIComponent(street) + ',' + encodeURIComponent(number) + ',' + encodeURIComponent(town) + '/@' + long + ',' + lat + ',17z';
                return mapsUrl
                
            }


            $('input[type=locUrlExtra]').focus(function() {
               //log('add maps to ', this.id); 
               initialize(this.id);
            });

            $('input[type=locUrlExtra]').keydown(function(event){
                if(event.keyCode == 13) {
                  event.preventDefault();
                  return false;
                }
            });

        }); 
    });

 </script>


[/#assign]



[@dws.skin skin="CPAuth2" head=cpweb_head ctxMenu=cpweb_ctxMenu orgName=orgName foot=foot ]
<section id="designdata">
    <h1>[@dws.txt key="cpweb.designdata.title" /]<span> ${prj.name?xhtml}</span></h1>
    <p>Bring your course to life by setting duration for activites, when a session starts and ends, the phone number for a conference call, etc...</p>

    [#global formPrefix="cpweb" /]
    <form action="${helper.urlFor('project.VerifyProjectDesignModule','updateNewDesign',[prj.projectId])}" name="createProjectGeneral" class="fullpage" method="post">
        [@mbform.alertsection]
        [/@mbform.alertsection]
        [#if errorFields?size > 0]
            <section class="alert">
              <h1>[@dws.txt key="form.alert.title" /]</h1>
              <ul>
                  <li>Check your input in the fields marked in red as the input does not match the required format.</li>
              </ul>
            </section>
        [/#if]
        
        <section class="field clearfix design">
            <ul>
                [#if components??]
                [#list components as component]
                <li class="mainitem clearfix">
                    [@displayComponent component /]
                </li>
                [/#list]
                [/#if]
            </ul>
        </section>
        [@mbform.infosection]
        [/@mbform.infosection]
        <section class="action">
            <input type="hidden" name="orgId" value="${org.id}" />
            <button type="submit" tabindex="3" class="primary save"><span>[@dws.txt key='form.action.verifyPrjDesign' /]</span></button>
            <a href="${helper.urlFor('project.ProjectModule', 'roster', [prj.projectId])}" tabindex="5" class="cancel">[@dws.txt key="form.action.cancel" /]</a>
        </section>

    </form>

</section>

[/@dws.skin]

[#macro displayComponent component]
[#if component.children?size > 0 || component.type == 'text' ]
    <div class="text">
        <h1>${component.properties.title!''}</h1>
        <p class="desc">${component.properties.description!''}</p>
    </div>
    [#if component.children?size > 0]
        [#list component.children as child]
            [#if child.properties.splitContainerPosition?? && child.properties.splitContainerPosition == "top" ]
                <div class="text">
                    [#if child.properties["title"]??]<h1>${child.properties["title"]}</h1>[/#if]
                    [#if child.properties["description"]??]<p class="desc">${child.properties["description"]}</p>[/#if]
                    [@listComponentFields child /]
                </div>
            [/#if]
         [/#list]
         <ul class="subitems">
            [#list component.children as child]
                [#if !child.properties.splitContainerPosition?? || child.properties.splitContainerPosition != "top" ]
                    <li class="subitem">[@displayComponent child /]</li>
                [/#if]
           [/#list]
        </ul>
    [/#if]
[#else]
    <div class="text">
        [#if component.properties["title"]??]<h1>${component.properties["title"]}</h1>[/#if]
        [#if component.properties["description"]??]<p class="desc">${component.properties["description"]}</p>[/#if]
        [@listComponentFields component /]
    </div>
[/#if]

[/#macro]

[#macro listComponentFields component]
[#if componentFieldSet[component.cid]??]
[#local fields = componentFieldSet[component.cid] /]





<div class="details clearfix">
    <ul>
        [#list fields as field]
        [#if component.type = "ev_classroom" && field.name = "locUrl"]
                [#assign visibility = "hidden"]
        [#else]
                [#assign visibility = "visible"]
        [/#if]
        <li class="${field.name} ${visibility}">[@listComponentField component field /]</li>
        [/#list]
    </ul>
</div>
[/#if]
[/#macro]

[#macro listComponentField component field]
[#assign extraAttrs = "" /]
[#assign fieldType = "text"]
[#if field.name = "duration"]
  [#assign fieldType = "number"]
  [#assign extraAttrs = "min='1'" /]
[#elseif field.name = "phone"]
  [#assign fieldType = "tel"]
[#elseif field.name = "url" || field.name = "locUrl"]
    [#assign fieldType = "url"]
    [#if (component.type = "ev_classroom") ]
        [#assign fieldType = "hidden"]
    [/#if]
[#elseif field.name = "locUrlExtra"]
  [#assign fieldType = "locUrlExtra"]
[#elseif field.name = "location"]
  [#assign fieldType = "location"]
[/#if]
[#assign fname = component.cid+'_'+field.name /]
[#if fieldType != "hidden"]
<label for="f${component.cid}_${field.name}">[@dws.txt key="cpweb.designdata.field."+field.name /]</label>
[/#if]
<input type="${fieldType}" ${extraAttrs} id="f${component.cid}_${field.name}" name="f${component.cid}_${field.name}" value="[@fieldValue fname /]" class="[#if errorFields?seq_contains(fname)]invalid[/#if]" [#if field.mandatory]required[/#if] />
[#if field.name = "duration"]
<span style="font-weight: bold;">  min</span>
[/#if]
[#if field.dataType == "DATETIME"]
<span>  ${prj.timezone.getDisplayName(userLocale)?xhtml}</span>
[/#if]

[#if field.dataType == "DATETIME"]
[@mbform._onreadyJavascript]
[#compress]
requirejs(['jquery-ui-timepicker-addon'], function() {
	$("#f${component.cid}_${field.name}").datetimepicker(dpSettings);
});
[/#compress]
[/@]
[/#if]
[/#macro]
