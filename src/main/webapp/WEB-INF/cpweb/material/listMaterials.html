[#ftl strip_text="true" /]

[#import "/material/materialsMenu.html" as mMenu /]

[#assign cpweb_head]


<script src="../../js/listMaterials.js">
</script>

${cpweb_head}

<link rel="stylesheet" type="text/css" href="${cocoboxCdn}/cocobox/css/bootstrap3.min.css">
<link rel="stylesheet" type="text/css" href="${cocoboxCdn}/cocobox/js/libs/dataTables/css/dataTables.bootstrap.css">

<style type="text/css">
    div.dataTables_info {
    color: #999;
    font-size: 12px;
    padding-top: 0;
    line-height: 40px;
    }
    div.dataTables_paginate {
    font-size: 12px;
    text-transform: uppercase;
    }
    table.dataTable thead > tr > th {
    font-weight: normal;
    text-transform: uppercase;
    color: #999;
    font-size: 12px;
    padding-left: 8px;
    }
    table.dataTable tbody {
    border-bottom: 2px solid #ddd;
    }
    .pagination>li>a, .pagination>li>span {
    border-radius: 50%;
    margin: 0 2px;
    }
    .pagination>li:first-child>a, .pagination>li:first-child>span,
    .pagination>li:last-child>a, .pagination>li:last-child>span {
    border-radius: 4px;
    }

</style>

[/#assign]


[#assign pagetitle='listMaterials' /]

[#assign foot]
${cpweb_foot}
<script>
    $('#tm_materials').addClass('activeItem').prev().addClass('prevItem');

    require(['dataTables-bootstrap'], function() {
        var pub = {
            listUrl: "${helper.urlFor('OrgMaterialJsonModule','listMats',[org.id])}"
        };
            
        var pTable = $('#materialstable').dataTable({
            "sDom": 'frtip',
            "bPaginate": true,
            "aaSorting": [[1,'asc']],
            "sAjaxSource": pub.listUrl,
            "aoColumnDefs": [
                {
                    "aTargets": [ 0 ],
                    "mData": "typeTitle",
                    "fnRender": function(oObj) {
                        return oObj.aData.type;
                    } 
                },
                {
                    "aTargets": [ 1 ],
                    "mData": "title",
                    "fnRender": function(oObj) {
                        return oObj.aData.title;
                    }
                },
                {
                    "aTargets": [ 2 ],
                    "mData": null,
                    "fnRender": function(oObj) {
                        if(oObj.aData.system == 'orgmat') {
                            return "<select data-action='action' data-id='" + oObj.aData.id + "'><option value=''>Actions</option><option value='edit'>edit</option><option value='delete'>delete</option></select>"
                        } else {
                            return '';
                        }
                    }
                }
            ],

            
            "sPaginationType": "full_numbers",
            "oLanguage": {
                "sSearch": "",
                "sZeroRecords": "No materials matches your query",
                "sEmptyTable": "<span class='emptytable'>No purchased products</span>",
                "sLoadingRecords": "<p>Loading materials...</p><img src='../../img/spinner-threedots.gif' />"
            },
            "fnInitComplete": function() {
                var nMaterialsProducts = pTable._('tr').length;
                $('#sm_purchased span').append('<span class="count">' + nMaterialsProducts + '</span>');
            }

        });
        
        
        $('#materialstable').on('change', 'select[data-action=action]', function() {
           
            var id = $(this).data('id');
            
            var action = $(this).val();
            
            if(action == 'delete') {
                deleteOrgMat(id);
            } else if (action == 'edit') {
                window.location.href = editOrgMatUrl + '/' + id;
            }
            
            $(this).val('');
            
        });
        
        
        var deleteOrgMatUrl = "${helper.urlFor('OrgMaterialJsonModule','deleteOrgMat')}";
        var editOrgMatUrl = "${helper.urlFor('material.MaterialModule','edit',[org.id])}";
    
        
        var deleteOrgMat = function(orgMatId) {
            var ajaxData = {"orgmatid": orgMatId};
            var ajaxSettings = {};
            ajaxSettings.data = ajaxData;
            ajaxSettings.success = processDeleteOrgMatAjaxResponse;
            require(['dabox-common'], function() {
                cocobox.confirmationDialog("Delete material",
                        "Do you want to permanently delete this material?",
                        function() {
                            cocobox.ajaxPost(deleteOrgMatUrl, ajaxSettings);
                        }
                );
            });

        };

        var processDeleteOrgMatAjaxResponse = function(data) {
            log('Ajax response', data);

            if (data.status == "OK") {
                //Delete row with error
                deleteOrgMatRow(data);
            } else {
                displayDeleteOrgMatError(data);
            }
        };

        var displayDeleteOrgMatError = function(data) {
            var lines = [];
            lines.push("This material cannot be deleted due to the foilowing reason.");
            lines.push("");
            if (data.activeLinkCount > 0) {
                lines.push("This material has an active access link");
                lines.push();
            }

            var pns = data.linkedProjectNames;
            if (pns && pns.length > 0) {
                lines.push("This material is used in the following projects:");
                lines.push();
                for(var i = 0; i<pns.length; i++) {
                    var pn = pns[i];
                    lines.push(pn);
                }
            }

            cocobox.infoDialog("Unable to delete material", lines);
        };

        
       
        /*
        listMaterialsProducts.listPurchasedMatsUrl = "${helper.urlFor('OrgMaterialJsonModule','listPurchasedMats',[org.id])}";
        listMaterialsProducts.newOrgMatUrl = "${helper.urlFor('material.ProductMaterialJsonModule','newProdLink',[org.id])}";
        listMaterialsProducts.deleteOrgMatLinkUrl = "${helper.urlFor('material.ProductMaterialJsonModule','deleteLink',[org.id])}";
        listMaterialsProducts.contextPath = "${contextPath}";
        listMaterialsProducts.sLang = "Search purchased materials";

        listMaterialsProducts.init();

        listMaterialsOrgMats.listOrgMatsUrl = "${helper.urlFor('OrgMaterialJsonModule','listOrgMats',[org.id])}";
        listMaterialsOrgMats.listPurchasedMatsUrl = "${helper.urlFor('OrgMaterialJsonModule','listPurchasedMats',[org.id])}";
        listMaterialsOrgMats.createOrgMatUrl =  "${helper.urlFor('CpMainModule','newMaterial',[org.id])}";
        listMaterialsOrgMats.editOrgMatUrl = "${helper.urlFor('material.MaterialModule','edit',[org.id])}";
        listMaterialsOrgMats.deleteOrgMatLinkUrl = "${helper.urlFor('OrgMaterialJsonModule','deleteOrgMatLink')}";
        listMaterialsOrgMats.deleteOrgMatUrl = "${helper.urlFor('OrgMaterialJsonModule','deleteOrgMat')}"
        listMaterialsOrgMats.contextPath = "${contextPath}";
        listMaterialsOrgMats.sLang = "Search added materials";

        listMaterialsOrgMats.init();
        */
    });
 
</script>
[/#assign]

[#assign cpweb_ctxMenu]
[@mMenu.materialsMenu selected="materials"][/@mMenu.materialsMenu]
[/#assign]

[@dws.skin skin="CPAuthMenu2" head=cpweb_head foot=foot ctxMenu=cpweb_ctxMenu orgName=orgName]
 
<a href="${helper.urlFor('CpMainModule','newMaterial',[org.id])}" class="btn btn-add navBackgroundColor">Add Material</a>
<h1>Materials</h1>
<div class='grid-header'>
    <div class='list-toggle'>[#include 'listToggle.html' /]</div>
</div>
<div id="listmaterials">
    <table id="materialstable" class="table table-bordered table-striped table-hover ">
        <thead>
            <tr>
                <th>type</th>
                <th>title</th>
                <th>actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

[/@dws.skin]
