[#ftl strip_text="true" /]

[#import "welcomeMessage.html" as wm /]

[#assign foot]
${cpweb_foot}

[#if security.isBoAdmin()]
<script>
    $('.orgname').show().delay(2000).slideUp();
</script>
[/#if]

<script>
    $('#tm_home').addClass('activeItem').prev().addClass('prevItem');
    function showActionsList() {
        $('#multiple-actions').slideUp();
        $('#list-actions').slideDown();
    }
    
    $(document).ready(function() {
        require(['dataTables-bootstrap','dabox-common', 'jquery.timeago'], function() {
            var actTable = $('#tw_actions').dataTable({
                "sDom": 'rt',
                "bPaginate": false,
                "aaSorting": [[3,'asc']],
                "aoColumnDefs": [
                    {
                        "sWidth": "64",
                        "bSortable": false,
                        "mData": null,
                        "sClass": "thumbnail",
                        "fnRender": function ( oObj ) {
                            return  '<a href="'+ oObj.aData.link + '"><img src="'+ oObj.aData.thumbnail + '" alt="' + oObj.aData.projectName +' thumbnail" /></a>';

                        },
                        "aTargets": [ 0 ]
                    },
                    {
                        "sWidth": "500",
                        "bSortable": false,
                        "mData": null,
                        "sClass": "info",
                        "fnRender": function ( oObj ) {
                            var template = '<a href="'+ oObj.aData.link + '"><p class="name">' + oObj.aData.projectName +'</p>';
                            
                            if (oObj.aData.bounceCount > 0 ){
                                template = template + '<div class="bounces"><span class="bounce-count">' + oObj.aData.bounceCount + '</span>' + 
                                '<span class="bounce-text">email(s) bounced back</span></div>';
                            }
                            
                            if (oObj.aData.alerts > 0) {
                                template = template + '<div class="alerts"><span class="alert-count">' +  oObj.aData.alerts + '</span>' + 
                                '<span class="alert-text">participant(s) could not be activated</span></div>'
                            }
                            
                            template = template + '</a>';
                            
                            return template;
                           

                        },
                        "aTargets": [ 1 ]
                    },
                    {
                        "sWidth": "150",
                        "mData": "oldest",
                        "bSortable": false,
                        "sClass": "date",
                        "fnRender": function ( oObj ) {
                            return '<abbr class="timeago" title="' + oObj.aData.oldestAgo + '">' + oObj.aData.oldestStr+ '</abbr>';
                        },
                        "aTargets": [ 2 ]
                    },
                    {
                       "sWidth": "120",
                       "mData": null,
                        "bSortable": false,
                        "sClass": "action-button",
                        "fnRender": function ( oObj ) {
                            return  '<a href="'+ oObj.aData.link + '" class="btn secondarybackgroundcolor">Action</a>'
                        },
                        "aTargets": [ 3 ]
                    }

                ],
                "sAjaxSource": "${helper.urlFor('CpJsonModule','listProjectAlerts',[org.id])}",
                "oLanguage": {
                    "sEmptyTable": "<span class='emptytable'>No bounced back emails.</span>",
                    "sLoadingRecords": "<p>Loading bounce back notifications...</p><img src='${contextPath}/img/spinner-threedots.gif' />"
                },
            "fnInitComplete": function() {
                var itemCount = actTable._('tr').length;
                if (itemCount > 0) {
                    $('#actions').slideDown();
                    $('.timeago').timeago();
                }
                if (itemCount > 1) {
                    $('#multiple-actions').slideDown();
                } else {
                    $('#list-actions').slideDown();
                }
            }
            });
            
            var favTable = $('#tw-favorites').dataTable({
                "dom": '<"row"<"col-sm-12"rt>>',
                "paging": false,
                "order": [[1,'asc']],
                "columnDefs": [
                    {
                        "aTargets": [ 0 ],
                        "orderable": false,
                        "width": "5%",
                        "data": function(row, type, set) {
                            if (row.favorite) {
                                row.favoriteDisplay = '<a onclick="toggleFavorite(this)"><span class="glyphicon glyphicon-star favorite-star" ></span></a>';
                            } else {
                                row.favoriteDisplay = '<a onclick="toggleFavorite(this)"><span class="glyphicon glyphicon-star-empty favorite-star"></span></a>';
                            }
                            if (type === 'display') {
                                return row.favoriteDisplay;
                            } else if (type === 'filter') {
                                return null;
                            } else if (type === 'sort') {
                                return row.favorite;
                            } else {
                                //Anything else and raw row
                                return row.favorite;
                            }
                        }
                    },
                    {
                        "targets": [ 1 ],
                        "width": "95%",
                        "orderable": false,
                        "className": "favdetails",
                        "data" : function(row, type, set) {
                            if (!row.nameDisplay) {
                                row.nameDisplay =   '<a href="'+ row.link + '"><p class="name">' + row.name +'</p>' +
                                '<p class="details"><span>Added: ' + row.added + '</span> <span>Invited: ' +  row.invited + '</span></p></a>';
                            }

                            if (type === 'display') {
                                return row.nameDisplay;
                            } else if (type === 'filter') {
                                return row.name;
                            } else if (type === 'sort') {
                                return row.name;
                            } else {
                                //Anything else and raw row
                                return row.name;
                            }
                        }
                    }
                ],
                "ajax": "${helper.urlFor('CpJsonModule','listFavoriteOrgProjects',[org.id])}",
                "language": {
                    "emptyTable": "<span class='emptytable'><a href='${helper.urlFor('CpMainModule','listProjects',[org.id])}'>Click the star next to a project to add it as a favorite.</a></span>",
                    "loadingRecords": ""
                }
            });
        } );
    });
                
    var addFavorite = "${helper.urlFor('favorites.FavoritesJsonModule','add')}";
    var deleteFavorite = "${helper.urlFor('favorites.FavoritesJsonModule','delete')}";

    function toggleFavorite(target) {
        log('Toggle ',target);

        var div = target;
        var tr = $(target).parent().parent().get()[0]
        var rowData = $('#tw_favorites').dataTable().fnGetData(tr);

        var prjId = rowData.id;
        log('Rowdata', rowData, prjId);

        var ajax = {};
        var ajaxData = {projectId: prjId};
        ajax.data = ajaxData;

        if ($(target).hasClass("isfav")) {
            ajax.success = function() {
                $(div).removeClass("isfav").addClass("isnotfav");
            }
            cocobox.ajaxPost(deleteFavorite,ajax);
        } else {
            ajax.success = function() {
                $(div).removeClass("isnotfav").addClass("isfav");
            }
            cocobox.ajaxPost(addFavorite,ajax);
        }
    }
                
</script>

[@portalSecurity.permissionBlock permission="CP_VIEW_ACCOUNTBALANCE"]
<script>
    require(['knockout'], function(ko) {

        function ProductBalance(data) {
            var self = this;
            self.title = ko.observable(data.title);
            self.thumbnail = ko.observable(data.thumbnail);
            self.availCredits = ko.observable(data.availCredits);
        }

        function AccountBalanceModel() {
            var self = this;

            self.products = ko.observableArray([]);

            self.productCount = ko.computed(function(){
                return self.products().length;                
            })

            self.creditCount = ko.computed(function(){
                var total = 0;
                $.each(self.products(),function(){
                    total+=this.availCredits();
                })
                return total;
            })
            
            self.topfive = ko.computed(function(){
                return self.products().slice(0,5);
            })

            self.loadData = function() {
                $.getJSON("${helper.urlFor('OrgMaterialJsonModule','listPurchasedMats',[org.id])}", function(allData) {
                    var mappedTasks = $.map(allData.aaData, function(item) { return new ProductBalance(item) });
                    mappedTasks.sort(function(a,b){
                        var diff = b.availCredits() - a.availCredits();
                        if (diff != 0) {
                            return diff;
                        }
                        if (a.title() < b.title()) {
                            return -1;
                        }
                        return 1;
                    });
                    self.products(mappedTasks);                    
                });
            }   
        }

        model = new AccountBalanceModel();
        ko.applyBindings(model);

        $(function() {
            model.loadData();
        })
            
    })
</script>
[/@]

[@portalSecurity.permissionBlock permission="CP_CREATE_ORGMAT"]
<script>
    require(["${dwsrt.config['apiweb.baseurl']}js/createanonproduct.js"], function() {
        //log("anonprodcreate loaded");
    });

    $("#addmatbtn").click(function() {
        CcbAnonymousProductUpload.open(function(pid) {
            //Do nothing
        }, {
            scope: "O${org.id?c}"
        });

    });
</script>
[/@]

[/#assign]


[@dws.skin skin="CPAuth3" head=cpweb_head ctxMenu=cpweb_ctxMenu foot=foot orgName=orgName earlycss=upweb_earlycss]

<article id="ccb-page-home">
    [#if portalSecurity.hasPermission("PRJ_ACTIVATE_PARTICIPANT")]
        <div class="ccb-card ccb-card-padding ccb-card-colored" id="actions" style="display: none;">
            <section id="multiple-actions" style="display: none;">
                <a class="btn btn-primary pull-right" onclick="showActionsList();"><span class="glyphicon glyphicon-chevron-down"></span> Show Issues</a>
                <h1>Action</h1>
                <p>There are multiple issues on your account that you need to take action on.</p>
            </section>
            <section id="list-actions" style="display: none;">
                <h1>Action</h1>
                <p>Take action on the following issues. Reach out to tech support as needed.</p>
                <table class="table table-hover ccb-table" id="tw_actions">
                    <tbody>
                    </tbody>
                </table>
            </section>
        </div>
    [/#if]


<div class="row">
<div class="col-sm-7">

    [#if portalSecurity.hasPermission("CP_CREATE_PROJECT") || portalSecurity.hasPermission("CP_LIST_PROJECTS")]
    <div class="ccb-flat-card ccb-flat-card-colored">
        [@portalSecurity.permissionBlock permission="CP_CREATE_PROJECT"]
        <section id="new-project">
            <h1>New Project</h1>
            <p>Get started with a new project by following the simple step-by-step instructions.</p>
            <p class="text-center">
                <a href="${helper.urlFor('project.NewProjectModule','setup',[org.id])}" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-plus-sign"></span> Add Project</a>
            </p>
        </section>
        [/@]
        [@portalSecurity.permissionBlock permission="CP_LIST_PROJECTS"]
        <section id="manage-projects">
            <a href="${helper.urlFor('CpMainModule','listProjects',[org.id])}" class="pull-right">View All Projects</a>
            <h4>Favorite Projects</h4>
            <table class="table table-hover table-condensed ccb-table" id="tw-favorites">
            </table>
        </section>
        [/@]
    </div>
    [/#if]
    [@portalSecurity.permissionBlock permission="CP_CREATE_ORGMAT"]
    <div class="ccb-card ccb-card-padding ccb-card-colored">
        <h2>Upload your materials</h2>
        <p>Add your own training materials to tailor the learning to your needs.</p>
        <div class="text-center">
            <div class="ui-helper-hidden" data-anoncreateprodelement="show">
                <div class="btn btn-primary-outlined" id="addmatbtn"><span class="glyphicon glyphicon-plus-sign"></span> Upload Material</div>
            </div>
        </div>
    </div>
    [/@]
    [@portalSecurity.permissionBlock permission="CP_CREATE_USER"]
    <div class="ccb-card ccb-card-padding ccb-card-colored">
        <h2>Invite an administrator</h2>
        <p>Invite additional administrators to manage projects from this portal.</p>
        <div class="text-center">
            <a href="${helper.urlFor('CreateUserModule','create',[org.id])}" class="btn btn-primary-outlined"><span class="glyphicon glyphicon-plus-sign"></span> Invite Administrator</a>
        </div>
    </div>
    [/@]

</div>
<div class="col-sm-5">
    [#if (dwsrt.config["cpweb.support.htmlsnippet"]) != ""]
        <div id="techsupportinfo" class="ccb-card ccb-card-padding ccb-card-colored">
            [#-- ${dwsrt.config["cpweb.support.htmlsnippet"]} --]
        </div>
    [/#if]
    [#if welcomeMessage??]
    <div class="ccb-card ccb-card-padding ccb-card-colored" id="contact">
        [@wm.welcomeBox welcomeMessage /]
    </div>
    [/#if]

    [@portalSecurity.permissionBlock permission="CP_VIEW_ACCOUNTBALANCE"]
    <div class="ccb-card ccb-card-padding ccb-card-colored" id="balance">
        <a href="${helper.urlFor('report.ReportModule','creditStatus', [org.id])}" class="pull-right">See Full Report</a>
        <h2>Your Account Status</h2>
        <div id="product-count" class="secondaryBackgroundColor">
            <span data-bind="text: productCount" class="count"></span><span  class="text">products available</span>
        </div>
        <h3>Top 5 balance</h3>
            <ul class="clearfix" data-bind="foreach: topfive">
                <li>
                    <img data-bind="attr: { src: thumbnail}" src="${cocoboxCdn}/cocobox/img/1x1-pixel.png" />
                    <p class="availCredits" data-bind="text: availCredits"></p>
                    <p class="title" data-bind="text: title"></p>
                </li>
            </ul>   
    </div>
    [/@]

</div>
</div>

</article>


[/@dws.skin]
