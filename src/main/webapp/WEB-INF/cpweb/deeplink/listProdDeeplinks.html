[#ftl strip_text="true" /]

[#!-- Netbean hint
<script src="../../js/deeplink/listDeeplinksProducts.js">
</script>
-->

[#import "productRenderer.html" as sProdRender /]

[#assign oListDetails]
<div class="loadspinner">[@common.spinner /]</div>
[/#assign]

[#assign pListDetails]
<div>
    <div class="loadspinner">[@common.spinner /]</div>
    <div class="linkfooter tooltip" title="Add a link if you want to use multiple links to access this material. This could be used for tracking links separately.">
        <button class="addlinkbutton">Add Link</button>
    </div>
</div>
[/#assign]

[#assign foot]
[@sProdRender.pRenderer][/@sProdRender.pRenderer]

${cpweb_foot}

<script>
    $('#menu-settings').addClass('subMenuExpanded');
    $('#menu-settings-directlinks-p').addClass('active');

    var fnFormatProdDetails = function (pTable, nTr) {
        return "${pListDetails?js_string}";
    }

    listDeeplinksProducts.listPurchasedMatsUrl = "${helper.urlFor('OrgMaterialJsonModule','listPurchasedMats',[org.id])}?exclude=project,orgunit";
    listDeeplinksProducts.listLinksUrl = "${helper.urlFor('deeplink.ProductMaterialJsonModule','listPurchasedMatLinks',[org.id])}";
    listDeeplinksProducts.listLinksHistoryUrl = "${helper.urlFor('deeplink.ProductMaterialJsonModule','listLinkTokens')}";
    listDeeplinksProducts.toggleActiveUrl = "${helper.urlFor('deeplink.ProductMaterialJsonModule','changeLinkStatus')}";
    listDeeplinksProducts.toggleActiveToUrl = "${helper.urlFor('deeplink.ProductMaterialJsonModule','changeLinkActiveTo')}";
    listDeeplinksProducts.toggleAutoaddUrl = "${helper.urlFor('deeplink.ProductMaterialJsonModule','changeAutoAddStatus')}";
    listDeeplinksProducts.newOrgMatUrl = "${helper.urlFor('deeplink.ProductMaterialJsonModule','newProdLink',[org.id])}";
    listDeeplinksProducts.deleteOrgMatLinkUrl = "${helper.urlFor('deeplink.ProductMaterialJsonModule','deleteLink',[org.id])}";
    listDeeplinksProducts.contextPath = "${contextPath}";
    listDeeplinksProducts.sLangÂ = "Search purchased materials";
    
    require(['dabox-datatables', 'jsrender', 'jquery-ui', 'bootstrap/editable'], function() {
        listDeeplinksProducts.init();
    });

    $(document).ready(function() {
        require(['dabox-common', 'jquery.form', 'dabox-formbeanjs'], function() {

            $('#addlinkcreditsform').ajaxForm(cocobox.getAjaxFormbeanHandler("addlinkcreditsform", function(data) {
                var totalId = "#opl"+data.opid;
                $(totalId).text(parseInt($(totalId).text(),10)+1);
                var linkId = "#assigned"+data.linkid;
                $(linkId).text(data.balance);
                $('#addlinkcredits').dialog('close');
            }));
        });
    });

    function showAddLinkCredits(linkid, opid) {
        $("#oplid").val(linkid);

        cocobox.getAjaxFormbeanHandler("addlinkcreditsform",null).beforeSend();

        cocobox.ajaxPost("${helper.urlFor('deeplink.ProductMaterialJsonModule','productBalance',[org.id])?js_string}/"+opid, {
            success: function(data) {
                $("#addlinkcreditsBalance").html(data.available);
            }
        })

        $("#addlinkcredits").dialog({
            width: 400,
            height: 400,
            modal: true,
            resizable: false
        });
    }
    
    function renderDeleteTokenColumn(oObj, linkId){
        [#if security.isBoAdmin()]
                return '<button type="button" onclick="listDeeplinksProducts.deleteToken(\'' +  oObj.aData.deleteLink + '\',\'' +  linkId + '\','+oObj.aData.amount+')">Delete</button>';
        [#else]
                return '';
        [/#if]
    }

    function updateProductLinkTitle(linkId, title) {
        cocobox.ajaxPost("${helper.urlFor('deeplink.ProductMaterialJsonModule','changeLinkTitle')}",{
            data: {
                "linkid": linkId,
                "title": title
            }
        })
    }
    </script>

[/#assign]


[@dws.skin skin="CPAuth3" head=cpweb_head foot=foot]
 
<h1>Direct Links</h1>

<div id="listmaterialstabs">
    <div id="tab_products">
        <section class="list">
            <table class="table ccb-table" id="listproducts">
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </section>
    </div>
</div>

[#include "addLinkCredits.html" /]

[/@dws.skin]

